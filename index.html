<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹æ‰“ç»¿â€œäºŒåå¹´ä¸€åˆ»â€è§‚æ¼”æ€»ç»“</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- (V5.3 éœ€æ±‚ â‘ ) å¼•å…¥ html2canvas åº“ç”¨äºä¿å­˜ä¸ºå›¾ç‰‡ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- (V5.4 ä¿®å¤) ä¸ºæˆªå›¾åŠŸèƒ½æ·»åŠ çš„ä¸´æ—¶æ ·å¼è¡¨ -->
    <style id="screenshot-fix-styles"></style>
    <style>
        /* å®šä¹‰ä¸»é¢˜é¢œè‰² */
        :root {
            --theme-bg: #f4f8f4; /* æ·¡æ·¡çš„ç»¿è‰²èƒŒæ™¯ */
            --theme-text: #22543d; /* æ·±ç»¿è‰²æ–‡æœ¬ */
            --theme-primary: #48bb78; /* ç»¿è‰² */
            --theme-primary-dark: #38a169;
            --theme-accent-bg: #fefcbf; /* äº®é»„è‰² (æˆå°±) */
            --theme-accent-border: #f6e05e;
            --theme-card-bg: #ffffff;
            --theme-border: #e2e8f0;
        }

        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            /* (V5 ç¾åŒ– â‘¢) æ¸å˜èƒŒæ™¯ */
            background-image: linear-gradient(180deg, #f8fcf8, var(--theme-bg));
            color: var(--theme-text);
            overscroll-behavior: none;
            /* (V5.1 ç§»é™¤) ç§»é™¤æ°´å°ç›¸å…³çš„æ ·å¼ */
        }
        
        /* (V5.1 ç§»é™¤) åˆ é™¤èƒŒæ™¯æ°´å° */

        /* ------------------------- */
        /* V3 æ•…äº‹ç‰ˆ (Story) æ ·å¼    */
        /* ------------------------- */
        #story-container {
            width: 100%;
            height: 100vh;
            max-height: 100svh; /* é€‚é…ç§»åŠ¨ç«¯ */
            overflow: hidden; 
            position: relative;
        }

        /* (V5 ç¾åŒ– â‘¡) ç¿»é¡µåŠ¨ç”» */
        .story-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent; /* (V5 ç¾åŒ– â‘¢) æ”¹ä¸ºé€æ˜ï¼Œè®© body æ¸å˜é€å‡ºæ¥ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            /* (V5 ç¾åŒ– â‘¡) é»˜è®¤çŠ¶æ€ (ä¸å¯è§) */
            opacity: 0;
            visibility: hidden;
            z-index: 5; /* é»˜è®¤åœ¨ä¸‹å±‚ */
        }
        
        .story-page.scrollable {
            justify-content: flex-start;
            padding-bottom: 8rem; /* ä¸ºå¯¼èˆªæŒ‰é’®ç•™å‡ºç©ºé—´ */
            height: auto; /* è¦†ç›– .story-page çš„ 100% é«˜åº¦ */
            min-height: 100vh; /* è‡³å°‘å æ»¡ä¸€å± */
        }

        .story-page.active {
            opacity: 1;
            visibility: visible;
            z-index: 10; /* æ¿€æ´»çš„é¡µé¢åœ¨ä¸Šå±‚ */
        }

        /* (V5 ç¾åŒ– â‘¡) ç¿»é¡µåŠ¨ç”» */
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slideInFromLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .slide-in-from-right { animation: slideInFromRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-out-to-left { animation: slideOutToLeft 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-in-from-left { animation: slideInFromLeft 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-out-to-right { animation: slideOutToRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }


        /* å¯¼èˆªæŒ‰é’® */
        #story-nav {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 1rem;
        }
        
        .story-nav-btn {
            background-color: var(--theme-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1);
        }
        .story-nav-btn:hover {
            background-color: var(--theme-primary-dark);
        }
        
        /* ------------------------- */
        /* V3/V4/V5 ç¾åŒ–æ ·å¼         */
        /* ------------------------- */

        /* (V5 ç¾åŒ– â‘ ) åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader-spinner {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border: 4px solid rgba(34, 84, 61, 0.1); /* --theme-text with 10% opacity */
            border-top-color: var(--theme-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* (V4.2 æ–°å¢) è¦æ±‚ â‘ : åˆ†æ®µæ·¡å‡ºåŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-item-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; /* åŠ¨ç”»å¼€å§‹å‰éšè— */
        }
        
        @keyframes sequentialFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .meta-ach-card {
            animation: sequentialFadeIn 0.6s ease-out forwards;
            opacity: 0; /* Start hidden */
            margin-bottom: 2rem;
            width: 100%;
            max-width: 500px;
        }

        /* åŸå¸‚æ°”æ³¡ (è¦æ±‚ â‘ ) */
        .city-bubble {
            display: inline-block;
            background-color: var(--theme-card-bg);
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 99px;
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        /* æ•…äº‹é¡µé€šç”¨æ ‡é¢˜ */
        .story-title {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            /* (V5 ç¾åŒ– â‘¢) æ¸å˜æ ‡é¢˜ */
            background: linear-gradient(45deg, var(--theme-text), var(--theme-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--theme-text); /* Fallback */
            margin-bottom: 1.5rem; /* 24px */
        }
        .story-subtitle {
            font-size: 1.125rem; /* 18px */
            color: var(--theme-text);
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        /* æˆå°±æ•…äº‹é¡µç¾åŒ– (è¦æ±‚ â‘¡) */
        .story-ach-title {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
            /* (V5 ç¾åŒ– â‘¢) æ¸å˜æ ‡é¢˜ */
            background: linear-gradient(45deg, var(--theme-primary-dark), var(--theme-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--theme-primary); /* Fallback */
            margin-bottom: 1rem;
        }
        .story-ach-desc {
            font-size: 1.125rem; /* 18px */
            font-style: italic;
            color: var(--theme-text);
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        .story-ach-details {
            background-color: var(--theme-card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--theme-border);
        }
        .story-ach-details .details-title {
            font-weight: 600;
            color: var(--theme-text);
            border-bottom: 1px dashed var(--theme-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem; /* å¢åŠ äº†é—´è· */
        }
        
        /* (V4.2 æ–°å¢) è¦æ±‚ â‘¡: æ—¶é—´è½´æ ·å¼ */
        .timeline-container {
            position: relative;
            padding-left: 2rem; /* ä¸ºæ—¶é—´è½´çº¿å’Œç‚¹ç•™å‡ºç©ºé—´ */
        }
        .timeline-line {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--theme-primary);
            opacity: 0.3;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -2.4rem; /* (2rem padding) - (0.4rem dot size / 2) */
            top: 0.3rem;
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 50%;
            background-color: var(--theme-primary);
            border: 2px solid var(--theme-bg);
        }
        .timeline-content {
            text-align: left;
        }
        .timeline-date {
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            color: var(--theme-text);
        }
        .timeline-city {
            font-weight: 500;
            font-size: 1rem; /* 16px */
            color: var(--theme-text);
        }
        .timeline-songs {
            font-size: 0.875rem;
            color: var(--theme-text);
            opacity: 0.7;
        }

        /* (V4.2 æ–°å¢) è¦æ±‚ â‘¢: é‡é€¢å¡ç‰‡æ ·å¼ */
        .reunion-container {
            width: 100%;
            space-y: 0.5rem;
        }
        .reunion-card {
            background-color: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-left: 4px solid var(--theme-primary);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: left;
            margin-bottom: 0.75rem;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .reunion-card h3 {
            font-weight: 600;
            font-size: 1rem;
            color: var(--theme-text);
        }
        .reunion-card p {
            font-size: 0.875rem;
            color: var(--theme-text);
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        .reunion-card p strong {
            color: var(--theme-primary);
            font-weight: 600;
        }


        /* ------------------------- */
        /* V1/V2 åŸå§‹æ ·å¼ (ä¿ç•™)       */
        /* ------------------------- */
        
        /* æŠ˜å èœå•æ ·å¼ */
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: rgba(0,0,0,0.03);
        }
        .accordion-content {
            display: none; /* é»˜è®¤éšè— */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .accordion-content.open {
            display: block;
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„é«˜åº¦ */
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.open .accordion-icon {
            transform: rotate(90deg);
        }
        
        /* (V4.1 æ–°å¢) å…¨é€‰æŒ‰é’®æ ·å¼ */
        .select-all-btn {
            font-size: 0.75rem; /* 12px */
            padding: 0.1rem 0.5rem;
            border-radius: 99px;
            background-color: var(--theme-bg);
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem;
        }
        .select-all-btn:hover {
            background-color: #e6f7eb;
        }


        /* æŠ¥å‘Šå¡ç‰‡æ ·å¼ */
        .report-card {
            background-color: var(--theme-card-bg);
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--theme-border);
            overflow: hidden;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar-bg {
            background-color: #e2e8f0;
            border-radius: 0.375rem; /* 6px */
            overflow: hidden;
            /* (V5.5 ä¿®å¤) æ·»åŠ  relative å®šä½ï¼Œä»¥ä¾¿ç»å¯¹å®šä½ç™¾åˆ†æ¯”æ–‡å­— */
            position: relative;
        }
        .progress-bar-fill {
            background-color: var(--theme-primary);
            transition: width 0.5s ease-in-out;
            /* (V5.5 ä¿®å¤) ç§»é™¤æ‰€æœ‰æ–‡æœ¬å’Œå¯¹é½æ ·å¼ï¼Œå®ƒåªä½œä¸ºè¿›åº¦æ¡ */
            height: 1.25rem; /* 20px - ä¿æŒåŸæ ·é«˜åº¦ */
        }
        
        /* (V5.5 ä¿®å¤) æ–°å¢ç™¾åˆ†æ¯”æ–‡å­—æ ·å¼ */
        .progress-bar-percentage {
            position: absolute;
            top: 0;
            bottom: 0;
            /* (V5.6 ä¿®å¤) ç§»é™¤ transform, html2canvas å…¼å®¹æ€§å·® */
            /* transform: translateX(-100%); */
            padding-right: 0.5rem; /* 8px é—´è· */
            
            /* ä» .progress-bar-fill ç§»è¿‡æ¥çš„æ ·å¼ */
            color: white;
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            
            /* (V5.6 ä¿®å¤) ç§»é™¤ flex å‚ç›´å±…ä¸­ï¼Œhtml2canvas ä¸å…¼å®¹ */
            /* display: flex; */
            /* align-items: center; */

            /* (V5.6 ä¿®å¤) ä½¿ç”¨ line-height å‚ç›´å±…ä¸­ï¼Œhtml2canvas å…¼å®¹æ€§æ›´å¥½ */
            line-height: 1.25rem; /* 20px, å¿…é¡»ä¸ .progress-bar-fill çš„é«˜åº¦ä¸€è‡´ */

            /* é˜²æ­¢æ–‡å­—æ¢è¡Œ */
            white-space: nowrap;
        }
        
        /* æˆå°±å¡ç‰‡ (ç”¨äºæœ€ç»ˆæŠ¥å‘Šé¡µ) */
        .achievement-card {
            background-color: var(--theme-accent-bg);
            border: 1px solid var(--theme-accent-border);
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            /* (V5.6 ä¿®å¤) æ·»åŠ  flex å±…ä¸­, è§£å†³ html2canvas æˆªå›¾å¯¹é½é—®é¢˜ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .achievement-card .title {
            color: #b7791f; /* æ·±é»„è¤è‰² */
            font-weight: 600;
        }
        .achievement-card .description {
            color: #744210; /* è¤è‰² */
        }
        .achievement-card .details {
            border-top: 1px dashed #d69e2e; /* é»„è¤è‰²è™šçº¿ */
        }
        
        /* è‡ªå®šä¹‰ Modal å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-box {
            background-color: white;
            padding: 1.5rem; /* 24px */
            border-radius: 0.5rem; /* 8px */
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <!-- ========================== -->
        <!--  1. åœºæ¬¡é€‰æ‹©é¡µé¢ (é»˜è®¤æ˜¾ç¤º)  -->
        <!-- ========================== -->
        <div id="selection-page" class="relative">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold" style="color: var(--theme-text);">è‹æ‰“ç»¿â€œäºŒåå¹´ä¸€åˆ»â€</h1>
                <p class="text-xl mt-1" style="color: var(--theme-text);">ä¸“å±è§‚æ¼”æ€»ç»“</p>
            </header>

            <main class="report-card p-4 md:p-6">
                <h2 class="font-semibold text-lg mb-4 text-center">è¯·é€‰æ‹©ä½ è§‚æ¼”è¿‡çš„åœºæ¬¡</h2>
                
                <!-- ä¸‰çº§æŠ˜å èœå•å®¹å™¨ -->
                <div id="accordion-container" class="space-y-2">
                    <!-- (V5 ç¾åŒ– â‘ ) åŠ è½½åŠ¨ç”»æ›¿æ¢ -->
                    <div id="data-loading-spinner" class="loader-container">
                        <div class="loader-spinner"></div>
                    </div>
                </div>

                <button id="generate-report-btn" class="w-full mt-6 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200" style="background-color: var(--theme-primary);" disabled>
                    <!-- (V5 ç¾åŒ– â‘ ) ä¿®æ”¹æŒ‰é’®åˆå§‹æ–‡å­— -->
                    è¯·ç¨å€™...
                </button>
            </main>
        </div>

        <!-- ========================== -->
        <!--  2. æ•…äº‹ç‰ˆé¡µé¢ (é»˜è®¤éšè—)  -->
        <!-- ========================== -->
        <div id="story-container" style="display: none;">
            <!-- JS åŠ¨æ€å¡«å…… .story-page -->
            <div id="story-nav" style="display: none;">
                <button id="prev-btn" class="story-nav-btn">ä¸Šä¸€é¡µ</button>
                <button id="next-btn" class="story-nav-btn">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>


        <!-- ========================== -->
        <!--  3. æœ€ç»ˆæŠ¥å‘Šé¡µé¢ (é»˜è®¤éšè—)  -->
        <!-- ========================== -->
        <div id="full-report-page" class="relative" style="display: none;">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold" style="color: var(--theme-text);">æˆ‘çš„ä¸“å±è§‚æ¼”æŠ¥å‘Š</h1>
                <p class="text-sm" style="color: var(--theme-text);">(æˆ‘çš„å®Œæ•´æ—…ç¨‹æ€»è§ˆ)</p>
            </header>

            <div class="space-y-6">
                
                <!-- æ¨¡å—1: æ€»è§ˆ -->
                <section class="report-card">
                    <div class="p-5">
                        <!-- (V5 ç¾åŒ– â‘¢) æ·»åŠ  Emoji -->
                        <h2 class="text-2xl font-semibold mb-4 text-center">ğŸ—ºï¸ æˆ‘çš„â€œäºŒåå¹´ä¸€åˆ»â€æ€»è§ˆ</h2>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div id="full-total-shows" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">æ€»åœºæ¬¡</div>
                            </div>
                            <div>
                                <div id="full-total-hours" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">æ€»æ—¶é•¿ (h)</div>
                            </div>
                            <div>
                                <div id="full-total-cities" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">æ€»åŸå¸‚</div>
                            </div>
                        </div>
                        <div id="full-city-list" class="mt-4 text-center text-sm">
                            <!-- ä½ çš„è¶³è¿¹éå¸ƒï¼šåŒ—äº¬ã€ä¸Šæµ·ã€... -->
                        </div>
                    </div>
                </section>
                
                <!-- æ¨¡å—1.5: ä¸“å±è§‚æ¼”å›å¿† (Gemini) (å·²æ³¨é‡Š) -->
                <!--
                <section class="report-card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">æˆ‘çš„ä¸“å±è§‚æ¼”å›å¿†</h2>
                        <div id="gemini-output" class="p-4 bg-gray-50 rounded-lg text-gray-700" style="display:none; white-space: pre-wrap; line-height: 1.75;"></div>
                        <div id="gemini-loading" class="text-center" style="display:none;">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                            <p class="mt-2 text-sm text-gray-500">æ­£åœ¨ä¸ºä½ ç”Ÿæˆä¸“å±å›å¿†...</p>
                        </div>
                        <button id="gemini-generate-btn" class="w-full mt-4 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200" style="background-color: var(--theme-primary);">
                            âœ¨ ç”Ÿæˆæˆ‘çš„ä¸“å±è§‚æ¼”å›å¿† âœ¨
                        </button>
                    </div>
                </section>
                -->

                <!-- æ¨¡å—2: æˆå°±å¢™ (è¦æ±‚ â‘£: ç®€åŒ–ç‰ˆ) -->
                <section class="report-card">
                    <div class="p-5">
                        <!-- (V5 ç¾åŒ– â‘¢) æ·»åŠ  Emoji -->
                        <h2 class="text-2xl font-semibold mb-4 text-center">ğŸ–ï¸ æˆ‘çš„æˆå°±å¢™</h2>
                        <div id="full-achievement-grid" class="space-y-3">
                            <!-- JS åŠ¨æ€ç”Ÿæˆ (ç®€åŒ–ç‰ˆ) -->
                        </div>
                    </div>
                </section>

                <!-- æ¨¡å—3: å…¨å·¡æ¼”ç¨€æœ‰åº¦ (è¦æ±‚ â‘£: ç®€åŒ–ç‰ˆ) -->
                <section class="report-card" id="full-rarity-grid">
                    <div class="p-5">
                        <!-- (V5 ç¾åŒ– â‘¢) æ·»åŠ  Emoji -->
                        <h2 class="text-2xl font-semibold mb-4 text-center">ğŸ’ æˆ‘çš„ç‚¹æ­Œç¨€æœ‰åº¦</h2>
                        <div class="grid grid-cols-3 gap-4 text-center mb-4">
                            <div>
                                <div id="full-rarity-first" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">å·¡æ¼”èµ·ç‚¹</div>
                            </div>
                            <div>
                                <div id="full-rarity-last" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">å·¡æ¼”ç»ˆç‚¹</div>
                            </div>
                            <div>
                                <div id="full-rarity-total-songs" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">ç‚¹æ­Œæ€»æ•°</div>
                            </div>
                        </div>
                        
                        <div id="full-rarity-levels" class="mt-4 pt-4 border-t border-gray-200">
                             <h3 class="font-semibold text-center mb-2">åˆ†çº§æ€»è§ˆ</h3>
                             <div class="grid grid-cols-4 gap-2 text-center">
                                 <div>
                                     <div id="full-rarity-l1-count" class="text-2xl font-bold">0</div>
                                     <div class="text-xs mt-1">ç»ç‰ˆä¸€åˆ»</div>
                                 </div>
                                 <div>
                                     <div id="full-rarity-l2-count" class="text-2xl font-bold">0</div>
                                     <div class="text-xs mt-1">é™å®šé‡é€¢</div>
                                 </div>
                                 <div>
                                     <div id="full-rarity-l3-count" class="text-2xl font-bold">0</div>
                                     <div class="text-xs mt-1">çè´µç›¸é‡</div>
                                 </div>
                                 <div>
                                     <div id="full-rarity-l4-count" class="text-2xl font-bold">0</div>
                                     <div class="text-xs mt-1">çƒ­é—¨å›å“</div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- æ¨¡å—4: ä¸ªäººç‚¹æ­Œåˆ†æ -->
                <section class="report-card">
                    <div class="p-5">
                        <!-- (V5 ç¾åŒ– â‘¢) æ·»åŠ  Emoji -->
                        <h2 class="text-2xl font-semibold mb-4 text-center">ğŸ¶ æˆ‘çš„ä¸ªäººç‚¹æ­Œç»†èŠ‚</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold text-lg mb-2">æˆ‘çš„å¸¸å¬æ›²ç›® Top 3</h3>
                                <ul id="full-encore-top3" class="list-decimal list-inside space-y-1">
                                </ul>
                            </div>
                             <div>
                                <!-- (V5 ç¾åŒ– ğŸ—£ï¸) æ ‡é¢˜ä¿®æ”¹ -->
                                <h3 class="font-semibold text-lg mb-2">æˆ‘çš„å®è—æ­Œæ›²</h3>
                                <ul id="full-encore-once" class="list-disc list-inside space-y-1">
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- æ¨¡å—5: ä¸“è¾‘ç‚¹äº®è®¡åˆ’ (å¯å±•å¼€ç‰ˆ) -->
                <section class="report-card">
                    <div class="p-5">
                        <!-- (V5 ç¾åŒ– â‘¢) æ·»åŠ  Emoji -->
                        <h2 class="text-2xl font-semibold mb-4 text-center">ğŸ’¿ ä¸“è¾‘ç‚¹äº®è®¡åˆ’</h2>
                        <div id="full-album-progress-grid" class="space-y-3">
                            <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </section>
                
                <!-- (V5.3 éœ€æ±‚ â‘ ) æ·»åŠ ä¿å­˜å›¾ç‰‡æŒ‰é’® -->
                <button id="save-as-image-btn" class="w-full mt-6 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200" style="background-color: var(--theme-primary);">
                    ä¿å­˜ä¸ºå›¾ç‰‡
                </button>
                
                <button id="reset-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-300">
                    è¿”å›é¦–é¡µé‡æ–°é€‰æ‹©
                </button>
            </div>
        </div>

        <!-- (V5 æ–°å¢) é¡µé¢åº•éƒ¨åé¦ˆ -->
        <footer class="text-center mt-8 pb-4 relative z-10">
            <p class="text-xs text-gray-400">
                å¦‚æœæœ‰ä»»ä½•bugè¯·å‘ @è§æ˜¥é£èµ·æ„ åé¦ˆ
            </p>
        </footer>

    </div>

    <!-- ========================== -->
    <!--  è‡ªå®šä¹‰ Modal å¼¹çª— (é»˜è®¤éšè—) -->
    <!-- ========================== -->
    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box text-center">
            <p id="modal-message" class="text-lg text-gray-700">è¿™æ˜¯ä¸€æ¡æç¤ºä¿¡æ¯ã€‚</p>
            <button id="modal-close-btn" class="w-full mt-4 text-white font-bold py-2 px-4 rounded-lg" style="background-color: var(--theme-primary);">
                å¥½çš„
            </button>
        </div>
    </div>


    <!-- ======================================================= -->
    <!--  æ ¸å¿ƒæ•°æ®ä¸åº”ç”¨é€»è¾‘
    <!-- ======================================================= -->
    <script>
        // =================================================================
        //
        //  1. æ ¸å¿ƒæ•°æ® (PRD V2.2)
        //  V4 ä¿®æ”¹: æ•°æ®å·²åˆ†ç¦»åˆ° data.json, æ­¤å¤„ä»…ä¸ºå˜é‡å£°æ˜
        //
        // =================================================================
        
        let concertList = [];
        let discography = [];
        let tourData = {};
        let songRarityDB = {};
        let achievementDB = [];
        let allCityExclusiveSongs = [];
        let allUnreleasedSongs = [];
        // (V4.2 æ–°å¢) è¦æ±‚ â‘¢: åå‘æ˜ å°„è¡¨
        let citySongReverseMap = {};


        // =================================================================
        //
        //  2. åº”ç”¨ç¨‹åºé€»è¾‘ (Application Logic)
        //
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- é¡µé¢å…ƒç´  ---
            const selectionPage = document.getElementById('selection-page');
            const storyContainer = document.getElementById('story-container');
            const storyNav = document.getElementById('story-nav');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const fullReportPage = document.getElementById('full-report-page');
            const accordionContainer = document.getElementById('accordion-container');
            // (V5 ç¾åŒ– â‘ ) ä¿®æ”¹åŠ è½½å ä½ç¬¦
            const dataLoadingSpinner = document.getElementById('data-loading-spinner');
            const generateBtn = document.getElementById('generate-report-btn');
            const resetBtn = document.getElementById('reset-btn');
            const modal = document.getElementById('alert-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            // (V5.3 éœ€æ±‚ â‘ ) è·å–ä¿å­˜å›¾ç‰‡æŒ‰é’®
            const saveAsImageBtn = document.getElementById('save-as-image-btn');
            // const geminiGenerateBtn = document.getElementById('gemini-generate-btn');
            // const geminiLoading = document.getElementById('gemini-loading');
            // const geminiOutput = document.getElementById('gemini-output');

            // --- V3 æ•…äº‹ç‰ˆçŠ¶æ€ ---
            let allReportData = {}; // å­˜å‚¨æ‰€æœ‰è®¡ç®—ç»“æœ
            let storyPages = [];    // æ•…äº‹é¡µé¢åºåˆ—
            let currentPageIndex = 0;
            let surpriseSongs = new Set(); // (è¦æ±‚ â‘¢) æ–°å¢: å­˜å‚¨æƒŠå–œæ­Œæ›²

            // --- é¡µé¢åˆå§‹åŒ– (V4 ä¿®æ”¹: å¼‚æ­¥åŠ è½½æ•°æ®) ---
            
            async function initializeApp() {
                try {
                    // 1. å¼‚æ­¥è·å–æ•°æ®
                    // (V4.1 ä¿®å¤: è·¯å¾„æŒ‡å‘æ ¹ç›®å½•)
                    const response = await fetch('data.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // 2. å¡«å……å…¨å±€æ•°æ®å˜é‡
                    concertList = data.concertList || [];
                    discography = data.discography || [];
                    tourData = data.tourData || {};
                    songRarityDB = data.songRarityDB || {};
                    achievementDB = data.achievementDB || [];
                    allCityExclusiveSongs = data.allCityExclusiveSongs || [];
                    allUnreleasedSongs = data.allUnreleasedSongs || [];

                    // (V4.2 æ–°å¢) è¦æ±‚ â‘¢: å»ºç«‹åŸå¸‚é™å®šæ­Œåå‘æ˜ å°„è¡¨ (ç”¨äº "é‡é€¢çš„ä¸€åˆ»")
                    for (const city in tourData.citySongs) {
                        const song = tourData.citySongs[city];
                        if (song) {
                            citySongReverseMap[song] = city;
                        }
                    }

                    // 3. æ¸²æŸ“é¡µé¢
                    // (V5 ç¾åŒ– â‘ ) éšè—åŠ è½½åŠ¨ç”»
                    dataLoadingSpinner.style.display = 'none'; 
                    renderAccordion(); // ä½¿ç”¨åˆšåŠ è½½çš„æ•°æ®æ„å»ºèœå•
                    
                    // 4. æ¿€æ´»æŒ‰é’®
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'ç”Ÿæˆæˆ‘çš„è§‚æ¼”æŠ¥å‘Š';
                    
                    // 5. ç»‘å®šæ ¸å¿ƒäº‹ä»¶
                    generateBtn.addEventListener('click', generateReport);

                } catch (error) {
                    console.error('Failed to load core data:', error);
                    // (V5 ç¾åŒ– â‘ ) ä¿®æ”¹é”™è¯¯æç¤º
                    dataLoadingSpinner.innerHTML = '<p class="text-center text-red-600">åœºæ¬¡æ•°æ®åŠ è½½å¤±è´¥ï¼<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>';
                    showAlert('æ ¸å¿ƒæ•°æ®åŠ è½½å¤±è´¥ï¼è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                }
            }
            
            /**
             * (V4.1 ä¿®æ”¹) æ¸²æŸ“ä¸‰çº§æŠ˜å èœå• (F1.1)
             * - ç®€åŒ–â€œæµ·å¤–åœ°åŒºâ€ (è¦æ±‚ â‘ )
             * - æ·»åŠ â€œå…¨é€‰â€æŒ‰é’® (è¦æ±‚ â‘¡)
             */
            function renderAccordion() {
                const groupedByRegion = concertList.reduce((acc, show) => {
                    (acc[show.region] = acc[show.region] || []).push(show);
                    return acc;
                }, {});

                let html = '';
                const regionsOrder = ['å¤§é™†åœ°åŒº', 'æ¸¯å°åœ°åŒº', 'æµ·å¤–åœ°åŒº'];

                for (const region of regionsOrder) {
                    if (!groupedByRegion[region]) continue;
                    
                    const regionShows = groupedByRegion[region];
                    const regionId = `region-${region.replace(/\s/g, '-')}`;

                    html += `
                        <div class="border border-gray-200 rounded-md">
                            <div id="${regionId}-header" class="accordion-header flex justify-between items-center p-3" data-target="#${regionId}-content">
                                <div class="flex items-center">
                                    <span class="font-semibold text-lg">${region}</span>
                                    <!-- V4.1: (è¦æ±‚ â‘¡) L1 å…¨é€‰æŒ‰é’® -->
                                    <button class="select-all-btn" data-target-id="#${regionId}-content" title="å…¨é€‰/å…¨ä¸é€‰ ${region}">å…¨é€‰</button>
                                </div>
                                <span class="accordion-icon text-gray-500">â–¶</span>
                            </div>
                            <div id="${regionId}-content" class="accordion-content pl-4 border-t border-gray-200">
                    `;

                    const groupedByCity = regionShows.reduce((acc, show) => {
                        (acc[show.city] = acc[show.city] || []).push(show);
                        return acc;
                    }, {});

                    // --- V4.1: (è¦æ±‚ â‘ ) ç®€åŒ–â€œæµ·å¤–åœ°åŒºâ€ ---
                    if (region === 'æµ·å¤–åœ°åŒº') {
                        // ç›´æ¥æ¸²æŸ“ä¸ºäºŒçº§å‹¾é€‰åˆ—è¡¨
                        regionShows.sort((a, b) => a.order - b.order); // æŒ‰æ—¥æœŸæ’åº
                        for (const show of regionShows) {
                            html += `
                                <label class="flex items-center space-x-2 cursor-pointer p-3 pl-2 border-b border-gray-100 last:border-b-0">
                                    <input type="checkbox" class="show-checkbox form-checkbox h-5 w-5 rounded" data-id="${show.id}" style="color: var(--theme-primary);">
                                    <span>${show.city} (${show.date})</span>
                                </label>
                            `;
                        }
                    } else {
                        // --- V4.1: (è¦æ±‚ â‘¡) å…¶ä»–åœ°åŒºä¿æŒä¸‰çº§ï¼Œå¹¶æ·»åŠ  L2 å…¨é€‰ ---
                        for (const city in groupedByCity) {
                            const cityShows = groupedByCity[city];
                            const cityId = `city-${city.replace(/\s/g, '-')}`;

                            html += `
                                <div class="border-b border-gray-200 last:border-b-0">
                                    <div id="${cityId}-header" class="accordion-header flex justify-between items-center p-3" data-target="#${cityId}-content">
                                        <div class="flex items-center">
                                            <span class="font-medium">${city}</span>
                                            <!-- V4.1: (è¦æ±‚ â‘¡) L2 å…¨é€‰æŒ‰é’® -->
                                            <button class="select-all-btn" data-target-id="#${cityId}-content" title="å…¨é€‰/å…¨ä¸é€‰ ${city}">å…¨é€‰</button>
                                        </div>
                                        <span class="accordion-icon text-gray-500">â–¶</span>
                                    </div>
                                    <div id="${cityId}-content" class="accordion-content pl-6 py-2 space-y-2">
                            `;
                            
                            cityShows.sort((a, b) => a.order - b.order);
                            for (const show of cityShows) {
                                html += `
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="show-checkbox form-checkbox h-5 w-5 rounded" data-id="${show.id}" style="color: var(--theme-primary);">
                                        <span>${show.name} (${show.date})</span>
                                    </label>
                                `;
                            }
                            html += `</div></div>`;
                        }
                    }
                    html += `</div></div>`;
                }
                accordionContainer.innerHTML = html;
                // V4.1 ä¿®æ”¹: è°ƒç”¨æ–°çš„æ¿€æ´»å‡½æ•°
                activateAccordionAndSelectAll();
            }

            /**
             * (V4.1 ä¿®æ”¹) æ¿€æ´»æŠ˜å èœå•å’Œå…¨é€‰æŒ‰é’®
             * ä½¿ç”¨äº‹ä»¶å§”æ‰˜
             */
            function activateAccordionAndSelectAll() {
                accordionContainer.addEventListener('click', (e) => {
                    const selectAllBtn = e.target.closest('.select-all-btn');
                    const header = e.target.closest('.accordion-header');

                    if (selectAllBtn) {
                        // --- Handle Select All (Request 2) ---
                        e.stopPropagation(); // é˜»æ­¢æŠ˜å èœå•å±•å¼€/å…³é—­
                        const targetId = selectAllBtn.dataset.targetId;
                        const content = document.querySelector(targetId);
                        if (!content) return;

                        const checkboxes = content.querySelectorAll('.show-checkbox');
                        if (checkboxes.length === 0) return;

                        // æ ¸å¿ƒé€»è¾‘: å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªæ²¡è¢«é€‰ä¸­ï¼Œåˆ™å…¨é€‰ï¼›å¦åˆ™å…¨ä¸é€‰
                        const shouldCheck = Array.from(checkboxes).some(box => !box.checked);
                        checkboxes.forEach(box => {
                            box.checked = shouldCheck;
                        });
                    
                    } else if (header) {
                        // --- Handle Accordion (Original Logic) ---
                        const content = document.querySelector(header.dataset.target);
                        if (!content) return;
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
            }

            /**
             * æ˜¾ç¤º/å…³é—­è‡ªå®šä¹‰å¼¹çª—
             */
            function showAlert(message) {
                modalMessage.textContent = message;
                modal.style.display = 'flex';
            }
            function closeAlert() {
                modal.style.display = 'none';
            }
            
            // --- æ ¸å¿ƒæŠ¥å‘Šç”Ÿæˆé€»è¾‘ (F2) ---

            function getSelectedShowIDs() {
                return Array.from(document.querySelectorAll('.show-checkbox:checked')).map(box => box.dataset.id);
            }
            
            function getSelectedShows(userShowIDs) {
                 return concertList.filter(show => userShowIDs.includes(show.id));
            }

            // (V5.2 ä¿®æ”¹) ä¿®å¤ Bug â‘¢ (2x2 å¸ƒå±€)
            function calculateOverview(userShowIDs, selectedShows) {
                const totalShows = userShowIDs.length;
                const totalHours = totalShows * 3;
                const uniqueCities = [...new Set(selectedShows.map(show => show.city))];
                const totalCities = uniqueCities.length;
                const cityListText = totalCities > 0 ? `æˆ‘çš„è¶³è¿¹éå¸ƒï¼š${uniqueCities.join('ã€')}` : 'æˆ‘è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•åœºæ¬¡ã€‚';
                
                // (V5.2 Fix for Feature â‘¢)
                let startDate = null;
                let endDate = null;
                let daysAccompanied = 0;
                
                if (selectedShows.length > 0) {
                    // æŒ‰æ—¥æœŸæ’åºæ‰¾åˆ°å¼€å§‹å’Œç»“æŸ
                    const sortedShows = [...selectedShows].sort((a, b) => new Date(a.date) - new Date(b.date));
                    startDate = sortedShows[0].date;
                    endDate = sortedShows[sortedShows.length - 1].date;
                    
                    // è®¡ç®—ç›¸ä¼´å¤©æ•°
                    const diffTime = Math.abs(new Date(endDate) - new Date(startDate));
                    // +1 å› ä¸º 5/4 åˆ° 5/5 åº”è¯¥æ˜¯ 2 å¤©, è€Œä¸æ˜¯ 1 å¤©
                    daysAccompanied = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                }

                return { totalShows, totalHours, totalCities, cityListText, uniqueCities, startDate, endDate, daysAccompanied };
            }

            // (V3 æ–°å¢) è®¡ç®—åŸå¸‚ä¸€åˆ»
            function calculateCityMoments(selectedShows) {
                const uniqueCities = [...new Set(selectedShows.map(show => show.city))];
                return uniqueCities.map(city => tourData.citySongs[city]).filter(Boolean); // è¿‡æ»¤æ‰ undefined
            }

            function getCompleteUserSongList(userShowIDs, selectedShows) {
                let allSongs = new Set();
                let allEncoreSongsWithDuplicates = [];
                let allEncoreSongs = new Set();
                
                if (userShowIDs.length > 0) {
                    tourData.fixedSongs.forEach(song => allSongs.add(song));
                }

                const uniqueCities = new Set(selectedShows.map(show => show.city));
                uniqueCities.forEach(city => {
                    if (tourData.citySongs[city]) {
                        allSongs.add(tourData.citySongs[city]);
                    }
                });

                userShowIDs.forEach(id => {
                    if (tourData.encoreSetlists[id]) {
                        tourData.encoreSetlists[id].forEach(song => {
                            allSongs.add(song);
                            allEncoreSongs.add(song);
                            allEncoreSongsWithDuplicates.push(song);
                        });
                    }
                });

                return {
                    uniqueSongs: allSongs, 
                    uniqueEncoreSongs: allEncoreSongs, 
                    encoreSongsWithDuplicates: allEncoreSongsWithDuplicates
                };
            }

            // (V3 é‡å¤§ä¿®æ”¹) F2.3: è®¡ç®—ä¸“è¾‘è¿›åº¦ (è¿”å› heard/unheard åˆ—è¡¨)
            function calculateAlbumProgress(userSongsSet) {
                return discography.map(album => {
                    let count = 0;
                    let heardTracks = [];
                    let unheardTracks = [];

                    album.tracks.forEach(track => {
                        const simplifiedTrack = track.replace(/[\s\.]/g, '');
                        const userHasSong = [...userSongsSet].some(userSong => 
                            userSong.replace(/[\s\.]/g, '') === simplifiedTrack
                        );
                        
                        if (userHasSong) {
                            count++;
                            heardTracks.push(track);
                        } else {
                            unheardTracks.push(track);
                        }
                    });
                    
                    const total = album.tracks.length;
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    
                    return {
                        name: album.albumName,
                        count,
                        total,
                        percentage,
                        heardTracks, // V3 æ–°å¢
                        unheardTracks // V3 æ–°å¢
                    };
                });
            }

            // F2.4: è®¡ç®—ä¸ªäººç‚¹æ­Œåˆ†æ
            function calculateEncoreStats(encoreSongsWithDuplicates) {
                const songCounts = encoreSongsWithDuplicates.reduce((acc, song) => {
                    acc[song] = (acc[song] || 0) + 1;
                    return acc;
                }, {});

                const sortedSongs = Object.entries(songCounts).sort(([, countA], [, countB]) => countB - countA);
                const top3 = sortedSongs.slice(0, 3).map(([name, count]) => ({ name, count }));
                const once = sortedSongs.filter(([, count]) => count === 1).map(([name]) => name);

                return { top3, once };
            }

            // (V3 é‡å¤§ä¿®æ”¹) F2.5: è®¡ç®—ç¨€æœ‰åº¦ (è¿”å›æ­Œæ›²åˆ—è¡¨) (å“åº”è¦æ±‚ â‘¢)
            function calculateRarity(uniqueEncoreSongs, userShowIDs) {
                let rarityFirst = 0, rarityLast = 0, rarityOnly = 0;
                let firstSongsList = [], lastSongsList = [], onlySongsList = [];
                let level1 = [], level2 = [], level3 = [], level4 = [];

                uniqueEncoreSongs.forEach(song => {
                    const rarityInfo = songRarityDB[song];
                    if (!rarityInfo) return;

                    if (userShowIDs.includes(rarityInfo.firstShowId)) {
                        rarityFirst++;
                        firstSongsList.push(song);
                    }
                    if (userShowIDs.includes(rarityInfo.lastShowId)) {
                        rarityLast++;
                        lastSongsList.push(song); 
                    }
                    if (rarityInfo.tourCount === 1) { 
                        rarityOnly++;
                    }

                    if (rarityInfo.tourCount === 1) level1.push(song);
                    else if (rarityInfo.tourCount <= 3) level2.push(song);
                    else if (rarityInfo.tourCount <= 5) level3.push(song);
                    else level4.push(song);
                });
                
                return { 
                    rarityFirst, rarityLast, rarityOnly,
                    firstSongsList: [...new Set(firstSongsList)], // å»é‡
                    lastSongsList: [...new Set(lastSongsList)],   // å»é‡
                    onlySongsList: [], 
                    level1, level2, level3, level4,
                    totalListSongs: level1.length + level2.length + level3.length + level4.length,
                    totalStatSongs: rarityFirst + rarityLast + rarityOnly
                };
            }
            
            // F2.6: è®¡ç®—ç‰¹æ®Šæˆå°± (æ‹†åˆ†æ­Œæ›²æˆå°±å’Œå…ƒæˆå°±)
            function calculateAchievements(userShowIDs, selectedShows, totalCities) {
                let songAchievements = [];
                let metaAchievements = [];  
                
                const showMap = new Map(selectedShows.map(show => [show.id, show]));
                
                const findSong = (songList, targetSong) => {
                    const simplifiedTarget = targetSong.replace(/[\s\.]/g, '');
                    return songList.some(song => song.replace(/[\s\.]/g, '').includes(simplifiedTarget));
                };

                // 1. éå† D5 æˆå°±æ•°æ®åº“
                achievementDB.forEach(ach => {
                    let unlockedDetails = [];
                    
                    if (ach.type === 'experience') {
                        if (userShowIDs.some(id => ach.triggerShows.includes(id))) {
                            metaAchievements.push({ ...ach });
                        }
                    } else if (ach.type === 'song') {
                        userShowIDs.forEach(id => {
                            if (ach.triggerMap[id]) {
                                const show = showMap.get(id);
                                const triggeredSongs = ach.triggerMap[id];
                                
                                const songsThisShow = [...new Set([
                                    ...tourData.fixedSongs,
                                    ...(tourData.citySongs[show.city] ? [tourData.citySongs[show.city]] : []),
                                    ...(tourData.encoreSetlists[id] || [])
                                ])];
                                
                                const matchedSongs = triggeredSongs.filter(ts => findSong(songsThisShow, ts));
                                
                                if (matchedSongs.length > 0) {
                                    unlockedDetails.push({
                                        date: show.date,
                                        city: show.city,
                                        songs: matchedSongs
                                    });
                                }
                            }
                        });
                        
                        if (unlockedDetails.length > 0) {
                            songAchievements.push({ ...ach, details: unlockedDetails });
                        }
                    }
                });
                
                // 2. è®¡ç®— 'ach_reunion' (é‡é€¢çš„ä¸€åˆ»)
                let reunionDetails = [];
                selectedShows.forEach(show => {
                    const city = show.city;
                    const id = show.id;
                    const nativeCitySong = tourData.citySongs[city];
                    const encore = tourData.encoreSetlists[id] || [];
                    
                    const reunionSongs = encore.filter(song => 
                        allCityExclusiveSongs.includes(song) && song !== nativeCitySong
                    );
                    
                    if (reunionSongs.length > 0) {
                        reunionDetails.push({ date: show.date, city: show.city, songs: reunionSongs });
                    }
                });
                if (reunionDetails.length > 0) {
                    songAchievements.push({
                        id: 'ach_reunion',
                        title: 'é‡é€¢çš„ä¸€åˆ»',
                        description: 'ä½ åœ¨ä¸€åˆ»ç¯èŠ‚ï¼Œå¬åˆ°äº†æœ¬ä¸å±äºè¿™åº§åŸå¸‚çš„é™å®šæ–°æ­Œã€‚',
                        type: 'song',
                        details: reunionDetails
                    });
                }
                
                // 3. è®¡ç®— 'ach_unreleased' (é—ç ä¸å†æœ‰æ†¾)
                let unreleasedDetails = [];
                selectedShows.forEach(show => {
                    const encore = tourData.encoreSetlists[show.id] || [];
                    const unreleasedSongs = encore.filter(song => allUnreleasedSongs.includes(song));
                    
                    if (unreleasedSongs.length > 0) {
                        unreleasedDetails.push({ date: show.date, city: show.city, songs: unreleasedSongs });
                    }
                });
                if (unreleasedDetails.length > 0) {
                    songAchievements.push({
                        id: 'ach_unreleased',
                        title: 'é—ç ä¸å†æœ‰æ†¾',
                        description: 'ä½ å¬åˆ°äº†è¿™äº›æœªæ”¶å½•åœ¨æ—§ç‰ˆå½•éŸ³å®¤ä¸“è¾‘ä¸­çš„â€œé—ç â€ä¹‹ä½œã€‚',
                        type: 'song',
                        details: unreleasedDetails
                    });
                }

                // 4. è®¡ç®— 'meta_city_conquer' (åŸå¸‚å…¨å‹¤)
                const cityShowCounts = concertList.reduce((acc, show) => {
                    acc[show.city] = (acc[show.city] || 0) + 1; return acc;
                }, {});
                const userCityCounts = selectedShows.reduce((acc, show) => {
                    acc[show.city] = (acc[show.city] || 0) + 1; return acc;
                }, {});
                
                let conqueredCities = [];
                for (const city in userCityCounts) {
                    if (userCityCounts[city] === cityShowCounts[city]) {
                        conqueredCities.push(city);
                    }
                }
                if (conqueredCities.length > 0) {
                    metaAchievements.push({
                        id: 'meta_city_conquer',
                        title: 'åŸå¸‚å…¨å‹¤',
                        description: `æˆ‘å…¨å‹¤äº† ${conqueredCities.join('ã€')}ï¼è¿™åº§åŸå¸‚çš„æ¯ä¸€åˆ»æˆ‘éƒ½æœªæ›¾ç¼ºå¸­ã€‚`,
                        type: 'experience'
                    });
                }
                
                // 5. è®¡ç®— 'meta_region_master' (å„åœ°å·¡æ¸¸)
                const regionsVisited = new Set(selectedShows.map(show => show.region));
                let achDescription = '';
                const hasAllRegions = regionsVisited.size === 3;
                const hasManyCities = totalCities >= 5;

                if (hasAllRegions && hasManyCities) {
                    achDescription = `çœŸæ­£çš„å·¡æ¼”æ—…äººï¼Œæˆ‘çš„è¶³è¿¹è·¨è¶Šäº†å±±å·ä¸æµ·æ´‹ï¼Œéå¸ƒ ${totalCities} åº§åŸå¸‚ï¼`;
                } else if (hasAllRegions) {
                    achDescription = 'çœŸæ­£çš„å·¡æ¼”æ—…äººï¼Œæˆ‘çš„è¶³è¿¹è·¨è¶Šäº†å±±å·ä¸æµ·æ´‹ã€‚';
                } else if (hasManyCities) {
                    achDescription = `çœŸæ­£çš„å·¡æ¼”æ—…äººï¼Œæˆ‘çš„è¶³è¿¹éå¸ƒ ${totalCities} åº§åŸå¸‚ï¼`;
                }

                if (hasAllRegions || hasManyCities) {
                    metaAchievements.push({
                        id: 'meta_region_master',
                        title: 'å„åœ°å·¡æ¸¸',
                        description: achDescription,
                        type: 'experience'
                    });
                }
                
                return { songAchievements, metaAchievements };
            }

            // --- V3 æ•…äº‹ç‰ˆæ¸²æŸ“é€»è¾‘ (F3) ---

            /**
             * (V3 æ–°å¢) æ¸²æŸ“æ¬¢è¿é¡µ
             */
            function renderWelcomePage(page, data) {
                page.innerHTML = `
                    <div class="animate-pulse">
                        <h1 class="story-title">æ­£åœ¨ä¸ºä½ ç”Ÿæˆ...</h1>
                        <p class="story-subtitle">è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨æ€»ç»“ä½ çš„ä¸“å±å›å¿†</p>
                    </div>
                `;
            }

            /**
             * (V5.2 ä¿®æ”¹) æ¸²æŸ“æ€»è§ˆé¡µ (è¦æ±‚ â‘¢)
             */
            function renderOverviewPage(page, data) {
                // (V5.2 Fix for Feature â‘¢)
                const journeyText = data.startDate ? 
                    `æˆ‘çš„äºŒåå¹´ä¸€åˆ»ä¹‹æ—…<br>ä» ${data.startDate} å¼€å§‹ï¼Œåˆ° ${data.endDate} ç»“æŸ` : '';

                page.innerHTML = `
                    <h1 class="story-title">æˆ‘çš„â€œäºŒåå¹´ä¸€åˆ»â€æ€»è§ˆ</h1>
                    
                    <!-- (V5.2 Fix for Feature â‘¢) 2x2 Grid -->
                    <div class="grid grid-cols-2 gap-8 text-center mb-6" style="animation: fadeIn 0.5s ease-out;">
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalShows}</div>
                            <div class="text-lg mt-2">æ€»åœºæ¬¡</div>
                        </div>
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalHours}</div>
                            <div class="text-lg mt-2">æ€»æ—¶é•¿ (h)</div>
                        </div>
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalCities}</div>
                            <div class="text-lg mt-2">æ€»åŸå¸‚</div>
                        </div>
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.daysAccompanied}</div>
                            <div class="text-lg mt-2">ç›¸ä¼´å¤©æ•°</div>
                        </div>
                    </div>
                    
                    <!-- (V5.2 Fix for Feature â‘¢) Journey Text -->
                    <p class="story-subtitle text-base">${journeyText}</p>
                `;
            }

            /**
             * (V3 ä¿®æ”¹ - è¦æ±‚ â‘ ) æ¸²æŸ“åŸå¸‚ä¸ä¸€åˆ»é¡µ
             */
            function renderCityMoments(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">æˆ‘çš„è¶³è¿¹ä¸ä¸€åˆ»</h1>
                    <button id="city-list-toggler" class="story-subtitle text-2xl font-semibold cursor-pointer hover:opacity-75 transition-opacity">
                        â€œæˆ‘é™ªè‹æ‰“ç»¿èµ°è¿‡äº†è¿™äº›åŸå¸‚â€
                        <span class="text-sm block">(ç‚¹å‡»æŸ¥çœ‹)</span>
                    </button>
                    <div id="city-list-bubbles" class="mb-6 max-w-md">
                        <!-- æ°”æ³¡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                    
                    <h3 class="story-subtitle text-2xl font-semibold mt-4">â€œæˆ‘å¬åˆ°äº†è¿™äº›çè´µçš„ä¸€åˆ»â€</h3>
                    <div class="text-left max-w-md w-full p-4 report-card">
                        <ul class="list-disc list-inside space-y-2">
                            ${data.cityMoments.length > 0 ? data.cityMoments.map(song => `<li class="text-lg">${song}</li>`).join('') : '<li class="text-lg italic">æš‚æ— </li>'}
                        </ul>
                    </div>
                `;
                
                page.querySelector('#city-list-toggler').addEventListener('click', (e) => {
                    e.currentTarget.style.display = 'none'; // éšè—æŒ‰é’®
                    const bubbleContainer = page.querySelector('#city-list-bubbles');
                    data.overview.uniqueCities.forEach((city, index) => {
                        const bubble = document.createElement('div');
                        bubble.className = 'city-bubble';
                        bubble.textContent = city;
                        bubble.style.animationDelay = `${index * 0.1}s`; // ä¾æ¬¡æ·¡å…¥
                        bubbleContainer.appendChild(bubble);
                    });
                });
            }

            // (V4.2 é‡æ„) æ¸²æŸ“â€œæˆ‘çš„è§è¯â€ - é»˜è®¤åˆ†æ®µæ·¡å…¥ (è¦æ±‚ â‘ )
            function renderDefaultDetails(details) {
                if (!details || details.length === 0) return '';
                
                let html = '<ul class="list-disc list-inside pl-2 text-sm space-y-1 mt-2">';
                html += details.map((detail, index) => 
                    `<li class="detail-item-fade-in" style="animation-delay: ${index * 0.15}s;">
                        [${detail.date} ${detail.city}] æˆ‘å¬åˆ°äº†ã€Š${detail.songs.join('ã€‹ã€ã€Š')}ã€‹
                    </li>`
                ).join('');
                html += '</ul>';
                return html;
            }

            // (V4.3 ä¿®æ”¹) æ¸²æŸ“â€œæˆ‘çš„è§è¯â€ - æ—¶é—´è½´ (è¦æ±‚ â‘ , â‘¡, â‘¢)
            function renderTimelineDetails(details, ach) {
                if (!details || details.length === 0) return '';

                // (V4.3) è¦æ±‚â‘ : å®šä¹‰å“ªäº›æˆå°±åªæ˜¾ç¤ºåŸå¸‚ï¼Œä¸æ˜¾ç¤ºæ­Œæ›²
                const simpleTimelineAchievements = ['ach_origin', 'ach_workout', 'ach_meet_again', 'ach_thank_you', 'ach_this_day', 'ach_miss_you'];
                // (V4.3) è¦æ±‚â‘¡, â‘¢: 'ach_fishleong', 'ach_unreleased' ä¼šè¿”å› falseï¼Œä»è€Œæ˜¾ç¤ºæ­Œæ›²
                const showSongs = !simpleTimelineAchievements.includes(ach.id);

                let html = '<div class="timeline-container">';
                html += '<div class="timeline-line"></div>'; // ä¸­å¿ƒçº¿
                html += details.map((detail, index) => `
                    <div class="timeline-item" style="animation-delay: ${index * 0.2}s;">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">${detail.date}</div>
                            <div class="timeline-city">${detail.city}</div>
                            ${showSongs ? `<div class="timeline-songs">æˆ‘å¬åˆ°äº†ã€Š${detail.songs.join('ã€‹ã€ã€Š')}ã€‹</div>` : ''}
                        </div>
                    </div>
                `).join('');
                html += '</div>';
                return html;
            }

            // (V4.2 æ–°å¢) æ¸²æŸ“â€œæˆ‘çš„è§è¯â€ - é‡é€¢å¡ç‰‡ (è¦æ±‚ â‘¢)
            function renderReunionDetails(details) {
                if (!details || details.length === 0) return '';
                
                let html = '<div class="reunion-container">';
                let animationIndex = 0;
                
                details.forEach((detail) => {
                    detail.songs.forEach((song) => {
                        const originalCity = citySongReverseMap[song] || 'æœªçŸ¥åŸå¸‚';
                        html += `
                        <div class="reunion-card" style="animation-delay: ${animationIndex * 0.2}s;">
                            <h3>ä½ å¬åˆ°äº†ï¼šã€Š${song}ã€‹</h3>
                            <p>è¿™æœ¬æ˜¯ <strong>${originalCity}</strong> çš„é™å®šä¸€åˆ»ï¼Œ</p>
                            <p>è€Œä½ åœ¨ <strong>[${detail.date} ${detail.city}]</strong> ä¸å®ƒæƒŠå–œé‡é€¢ã€‚</p>
                        </div>`;
                        animationIndex++;
                    });
                });
                
                html += '</div>';
                return html;
            }


            /**
             * (V4.3 ä¿®æ”¹ - é‡æ„) æ¸²æŸ“å•ä¸ªæˆå°±é¡µ (ç°åœ¨æ˜¯è·¯ç”±)
             */
            function renderAchievementPage(page, ach) {
                // (V4.3) 1. å†³å®šä½¿ç”¨å“ªç§æ¸²æŸ“æ–¹å¼
                // (è¦æ±‚ â‘¡, â‘¢) 'é±¼ä¸ç³¸' å’Œ 'é—ç ' ä¹Ÿä½¿ç”¨æ—¶é—´è½´
                const timelineAchievements = ['ach_origin', 'ach_workout', 'ach_meet_again', 'ach_thank_you', 'ach_this_day', 'ach_miss_you', 'ach_fishleong', 'ach_unreleased'];
                let detailsHTML = '';
                
                // (V4.2) 2. ä¿è¯è§è¯æŒ‰æ—¥æœŸæ’åº
                const sortedDetails = (ach.details || []).sort((a, b) => new Date(a.date) - new Date(b.date));

                if (ach.id === 'ach_reunion') {
                    // è¦æ±‚ â‘¢: æ¸²æŸ“é‡é€¢å¡ç‰‡
                    detailsHTML = renderReunionDetails(sortedDetails);
                } else if (timelineAchievements.includes(ach.id)) {
                    // è¦æ±‚ â‘ , â‘¡, â‘¢: æ¸²æŸ“æ—¶é—´è½´
                    // (V4.3) ä¼ å…¥ 'ach' æœ¬èº«ï¼Œè®©æ¸²æŸ“å™¨å†³å®šæ˜¯å¦æ˜¾ç¤ºæ­Œæ›²
                    detailsHTML = renderTimelineDetails(sortedDetails, ach); 
                } else {
                    // è¦æ±‚ â‘  (é»˜è®¤): é»˜è®¤ä½¿ç”¨åˆ†æ®µæ·¡å…¥åˆ—è¡¨ (ä¾‹å¦‚ å°é£)
                    detailsHTML = renderDefaultDetails(sortedDetails);
                }

                // (V4.2) 3. æ¸²æŸ“é¡µé¢
                page.innerHTML = `
                    <div class="text-center w-full max-w-md" style="animation: fadeIn 0.5s ease-out;">
                        <h1 class="story-ach-title">ğŸ† ${ach.title}</h1>
                        <p class="story-ach-desc">â€œ${ach.description}â€</p>
                        
                        ${detailsHTML ? `
                        <div class="story-ach-details">
                            <div class="details-title">æˆ‘çš„è§è¯:</div>
                            ${detailsHTML} 
                        </div>
                        ` : ''}
                        
                        ${ach.lyric ? `<p class="text-gray-500 italic mt-4">â€œ${ach.lyric}â€</p>` : ''}
                    </div>
                `;
            }

            /**
             * (V3 æ–°å¢) æ¸²æŸ“â€œå…ƒâ€æˆå°±åˆå¹¶é¡µ
             */
            function renderMetaAchievementPage(page, achievements) {
                page.innerHTML = `
                    <h1 class="story-title">æˆ‘çš„ç‰¹åˆ«å°è®°</h1>
                    <div class="flex flex-col items-center w-full">
                    ${achievements.map((ach, index) => `
                        <div class="meta-ach-card report-card p-5 text-center" style="animation-delay: ${index * 0.4}s;">
                            <h2 class="story-ach-title text-2xl mb-2">ğŸ† ${ach.title}</h2>
                            <p class="story-ach-desc text-base">â€œ${ach.description}â€</p>
                        </div>
                    `).join('')}
                    </div>
                `;
            }

            /**
             * (V3 ä¿®æ”¹) æ¸²æŸ“ç¨€æœ‰åº¦ç»Ÿè®¡é¡µ (èµ·ç‚¹/ç»ˆç‚¹)
             */
            function renderRarityStatsPage(page, data) {
                const renderSongList = (songs) => {
                    if (!songs || songs.length === 0) return '<li class="text-gray-500 italic text-sm">æš‚æ— </li>';
                    return songs.map(s => `<li class="text-sm">${s}</li>`).join('');
                };

                page.innerHTML = `
                    <h1 class="story-title">å®‡å®™ä¸­çš„ç¨€æœ‰è®¯å·</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl">
                        <div class="report-card p-4">
                            <div class="text-5xl font-bold" style="color: var(--theme-primary);">${data.rarityFirst}</div>
                            <div class="text-lg font-semibold mt-1">å·¡æ¼”èµ·ç‚¹</div>
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ç‚¹æ­Œä¸­æˆ‘å¬åˆ°äº†è¿™äº›æ­Œçš„é¦–æ¬¡æ¼”å”±)</p>
                            <ul class="list-disc list-inside mt-2 text-left">${renderSongList(data.firstSongsList)}</ul>
                        </div>
                        <div class="report-card p-4">
                            <div class="text-5xl font-bold" style="color: var(--theme-primary);">${data.rarityLast}</div>
                            <div class="text-lg font-semibold mt-1">å·¡æ¼”ç»ˆç‚¹</div>
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ç‚¹æ­Œä¸­æˆ‘å¬åˆ°äº†è¿™äº›æ­Œçš„æœ€åä¸€æ¬¡æ¼”å”±)</p>
                            <ul class="list-disc list-inside mt-2 text-left">${renderSongList(data.lastSongsList)}</ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V5.3 éœ€æ±‚ â‘¡) æ¸²æŸ“ç¨€æœ‰åº¦åˆ†çº§é¡µ (L1-L4)
             */
            function renderRarityLevelsPage(page, data) {
                const renderSongList = (songs) => {
                    if (!songs || songs.length === 0) return '<li class="text-gray-500 italic text-sm">æœªè§£é”æ­¤ç¨€æœ‰åº¦</li>';
                    return songs.map(s => `
                        <li class="flex items-center space-x-2">
                            <input type="checkbox" class="surprise-song-check form-checkbox h-4 w-4 rounded" data-song-name="${s}" style="color: var(--theme-primary);">
                            <label class="text-sm">${s}</label>
                        </li>
                    `).join('');
                };

                page.innerHTML = `
                    <h1 class="story-title">ç‚¹æ­Œæ± çš„å®è—</h1>
                    <p class="story-subtitle text-sm mb-4">
                        è¯·åœ¨ä»¥ä¸‹ä½ å¬è¿‡ç°åœºçš„æ­Œæ›²å‹¾é€‰<br>ä½ è®¤ä¸ºæœ€æƒŠå–œã€æœ€ç‰¹åˆ«çš„æ­Œæ›²ï¼Œ<br>å®ƒä»¬å°†å‡ºç°åœ¨æœ€ç»ˆæŠ¥å‘Šçš„â€œæˆ‘çš„å®è—æ­Œæ›²â€åˆ—è¡¨ä¸­ã€‚
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-3xl">
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">â€œç»ç‰ˆä¸€åˆ»â€ (${data.level1.length})</h3>
                            <!-- V5.3 éœ€æ±‚ â‘¡: æ·»åŠ è§£é‡Š -->
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ä¸­å…±è¢«ç‚¹åˆ°è¿‡ 1 æ¬¡)</p>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level1)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">â€œé™å®šé‡é€¢â€ (${data.level2.length})</h3>
                            <!-- V5.3 éœ€æ±‚ â‘¡: æ·»åŠ è§£é‡Š -->
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ä¸­å…±è¢«ç‚¹åˆ°è¿‡ 2-3 æ¬¡)</p>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level2)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">â€œçè´µç›¸é‡â€ (${data.level3.length})</h3>
                            <!-- V5.3 éœ€æ±‚ â‘¡: æ·»åŠ è§£é‡Š -->
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ä¸­å…±è¢«ç‚¹åˆ°è¿‡ 4-5 æ¬¡)</p>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level3)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">â€œçƒ­é—¨å›å“â€ (${data.level4.length})</h3>
                            <!-- V5.3 éœ€æ±‚ â‘¡: æ·»åŠ è§£é‡Š -->
                            <p class="text-xs text-gray-500 mt-1">(åœ¨å·¡æ¼”ä¸­å…±è¢«ç‚¹åˆ°è¿‡ 6 æ¬¡åŠä»¥ä¸Š)</p>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level4)}</ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 æ–°å¢) æ¸²æŸ“ä¸ªäººç‚¹æ­Œé¡µ
             */
            function renderEncorePage(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">å±äºæˆ‘çš„å®‰å¯æ—¶å…‰</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        <div class="report-card p-4">
                            <h3 class="font-semibold text-xl mb-2">æˆ‘çš„å¸¸å¬æ›²ç›® Top 3</h3>
                            <ul class="list-decimal list-inside space-y-1 text-left">
                                ${data.top3.length > 0 ? data.top3.map(s => `<li class="text-lg">${s.name} (${s.count} æ¬¡)</li>`).join('') : '<li class="text-gray-500 italic">æˆ‘å¬è¿‡çš„ç‚¹æ­Œéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼</li>'}
                            </ul>
                        </div>
                         <div class="report-card p-4">
                            <h3 class="font-semibold text-xl mb-2">æˆ‘çš„ä¸€é¢ä¹‹ç¼˜æ›²ç›®</h3>
                            <ul class="list-disc list-inside space-y-1 text-left">
                                ${data.once.length > 0 ? data.once.map(s => `<li class="text-base">${s}</li>`).join('') : '<li class="text-gray-500 italic">æˆ‘çš„æ¯é¦–ç‚¹æ­Œéƒ½å……æ»¡ç¼˜åˆ†ï¼</li>'}
                            </ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 æ–°å¢) æ¸²æŸ“å¯å±•å¼€çš„ä¸“è¾‘é¡µ
             */
            function renderAlbumPage(page, data) {
                // æŒ‰è¿›åº¦æ’åº
                data.sort((a, b) => b.percentage - a.percentage);
                
                page.innerHTML = `
                    <h1 class="story-title">æˆ‘çš„éŸ³ä¹æ‹¼å›¾</h1>
                    <div class="w-full max-w-md report-card p-4 space-y-3">
                        ${data.map((album, index) => `
                            <div class="border border-gray-200 rounded-md">
                                <div id="album-header-${index}" class="accordion-header p-3" data-target="#album-content-${index}">
                                    <!-- (V5.6 ä¿®å¤) å¢åŠ é—´è· -->
                                    <div class="flex justify-between text-sm font-medium mb-2">
                                        <span class="font-semibold">${album.name}</span>
                                        <span>(${album.count} / ${album.total})</span>
                                    </div>
                                    <!-- (V5.5 ä¿®å¤) HTML ç»“æ„ä¿®æ”¹ï¼šæ–‡å­—å’Œè¿›åº¦æ¡åˆ†ç¦» -->
                                    <div class="progress-bar-bg" style="height: 1.25rem;">
                                        <div class="progress-bar-fill" style="width: ${album.percentage}%;"></div>
                                        ${album.percentage > 10 ? `
                                        <!-- (V5.6 ä¿®å¤) æ”¹ç”¨ 'right' å®šä½, å¼ƒç”¨ 'left' å’Œ 'transform' -->
                                        <span class="progress-bar-percentage" style="right: calc(100% - ${album.percentage}%);">
                                            ${album.percentage}%
                                        </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <div id="album-content-${index}" class="accordion-content p-3 border-t border-gray-200 text-left">
                                    <h4 class="font-semibold text-sm">å·²å¬è¿‡ (${album.heardTracks.length})</h4>
                                    <ul class="list-disc list-inside pl-2 text-xs text-green-700">
                                        ${album.heardTracks.length > 0 ? album.heardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">æš‚æ— </li>'}
                                    </ul>
                                    <h4 class="font-semibold text-sm mt-2">æœªå¬è¿‡ (${album.unheardTracks.length})</h4>
                                    <ul class="list-disc list-inside pl-2 text-xs text-gray-400">
                                        ${album.unheardTracks.length > 0 ? album.unheardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">æš‚æ— </li>'}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                page.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = page.querySelector(header.dataset.target);
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    });
                });
            }

            /**
             * (V3 ä¿®æ”¹) æ¸²æŸ“æœ€ç»ˆæ€»è§ˆé¡µ (å…¥å£)
             */
            function renderFullReport(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">æˆ‘çš„æ—…ç¨‹å·²æ±‡æ€»</h1>
                    <p class="story-subtitle">è¿™æ˜¯æˆ‘çš„â€œäºŒåå¹´ä¸€åˆ»â€å®Œæ•´æŠ¥å‘Šï¼Œ<br>æ„Ÿè°¢æˆ‘å‚ä¸è¿‡è¿™ä¸€åˆ»ï¼Œæˆä¸ºè¿™è¶Ÿæ—…ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚</p>
                    <button id="show-full-report-btn" class="story-nav-btn">æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š</button>
                `;
                
                // å¡«å……æœ€ç»ˆæŠ¥å‘Šé¡µçš„æ•°æ® (åœ¨åå°)
                populateFullReportPage(data);
                
                page.querySelector('#show-full-report-btn').addEventListener('click', () => {
                    storyContainer.style.display = 'none';
                    fullReportPage.style.display = 'block';
                    storyNav.style.display = 'none'; 
                    window.scrollTo(0, 0);
                });
            }

            
            // --- æœ€ç»ˆæŠ¥å‘Šé¡µ æ¸²æŸ“å‡½æ•° (F3 - Full Report) ---

            /**
             * å¡«å……æœ€ç»ˆæŠ¥å‘Šé¡µ
             */
            function populateFullReportPage(data) {
                renderFullReportOverview(data.overview);
                renderFullReportAchievements(data.allAchievements);
                renderFullReportRarity(data.rarity);
                renderFullReportEncore(data.encore, [...surpriseSongs]); 
                renderFullReportAlbums(data.albums);
            }

            function renderFullReportOverview(data) {
                document.getElementById('full-total-shows').textContent = data.totalShows;
                document.getElementById('full-total-hours').textContent = data.totalHours;
                document.getElementById('full-total-cities').textContent = data.totalCities;
                document.getElementById('full-city-list').textContent = data.cityListText;
            }

            /**
             * (V3 æ–°å¢ - è¦æ±‚ â‘£) æ¸²æŸ“ç®€åŒ–çš„æˆå°±å¢™
             */
            function renderFullReportAchievements(achievementsData) {
                const container = document.getElementById('full-achievement-grid');
                if (achievementsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic text-center">æˆ‘å°šæœªè§£é”ä»»ä½•ç‰¹æ®Šæˆå°±ã€‚</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="flex flex-wrap justify-center gap-2">
                        ${achievementsData.map(ach => `
                            <!-- (V5.6 ä¿®å¤) æ·»åŠ  flex å±…ä¸­ -->
                            <div class="achievement-card p-2 px-3 flex items-center justify-center">
                                <span class="title text-sm">ğŸ† ${ach.title}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            /**
             * (V3 ä¿®æ”¹ - æœ€ç»ˆç‰ˆ) æ¸²æŸ“ç®€åŒ–çš„ç¨€æœ‰åº¦
             */
            function renderFullReportRarity(data) {
                const raritySection = document.getElementById('full-rarity-grid').closest('section.report-card');
                
                if (data.totalListSongs === 0 && data.totalStatSongs === 0) {
                    raritySection.style.display = 'none';
                    return;
                }
                raritySection.style.display = 'block';

                // 1. æ¸²æŸ“ç»Ÿè®¡ (Start/End/Exclusive)
                document.getElementById('full-rarity-first').textContent = data.rarityFirst;
                document.getElementById('full-rarity-last').textContent = data.rarityLast;
                // V4 æœ€ç»ˆä¿®æ”¹: 'ç‹¬å®¶ä¸€åˆ»' -> 'ç‚¹æ­Œæ€»æ•°'
                document.getElementById('full-rarity-total-songs').textContent = data.totalListSongs;
                
                // 2. æ¸²æŸ“ L1-L4 æ•°é‡
                document.getElementById('full-rarity-l1-count').textContent = data.level1.length;
                document.getElementById('full-rarity-l2-count').textContent = data.level2.length;
                document.getElementById('full-rarity-l3-count').textContent = data.level3.length;
                document.getElementById('full-rarity-l4-count').textContent = data.level4.length;
            }
            
            /**
             * (V3 ä¿®æ”¹ - è¦æ±‚ â‘£) æ¸²æŸ“ä¸ªäººç‚¹æ­Œ (Top3 + æƒŠå–œ)
             */
            function renderFullReportEncore(data, surpriseSongsList) {
                document.getElementById('full-encore-top3').innerHTML = data.top3.map(s => `<li>${s.name} (${s.count} æ¬¡)</li>`).join('') || '<li class="text-gray-500 italic">æˆ‘å¬è¿‡çš„ç‚¹æ­Œéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼</li>';
                
                document.getElementById('full-encore-once').innerHTML = surpriseSongsList.length > 0 
                    ? surpriseSongsList.map(s => `<li>${s}</li>`).join('') 
                    : '<li class="text-gray-500 italic">æš‚æ—  (é‡æ–°è¿”å›æ•…äº‹é¡µå‹¾é€‰å§ï¼)</li>';
            }
            
            // (V3 ä¿®æ”¹) æœ€ç»ˆæŠ¥å‘Šé¡µçš„ä¸“è¾‘åˆ—è¡¨ (å¯å±•å¼€)
            function renderFullReportAlbums(data) {
                const container = document.getElementById('full-album-progress-grid');
                // æŒ‰è¿›åº¦æ’åº
                data.sort((a, b) => b.percentage - a.percentage);
                
                container.innerHTML = data.map((album, index) => `
                    <div class="border border-gray-200 rounded-md">
                        <div id="full-album-header-${index}" class="accordion-header p-3" data-target="#full-album-content-${index}">
                            <!-- (V5.6 ä¿®å¤) å¢åŠ é—´è· -->
                            <div class="flex justify-between text-sm font-medium mb-2">
                                <span class="font-semibold">${album.name}</span>
                                <span>(${album.count} / ${album.total})</span>
                            </div>
                            <!-- (V5.5 ä¿®å¤) HTML ç»“æ„ä¿®æ”¹ï¼šæ–‡å­—å’Œè¿›åº¦æ¡åˆ†ç¦» -->
                            <div class="progress-bar-bg" style="height: 1.25rem;">
                                <div class="progress-bar-fill" style="width: ${album.percentage}%;"></div>
                                ${album.percentage > 10 ? `
                                <!-- (V5.6 ä¿®å¤) æ”¹ç”¨ 'right' å®šä½, å¼ƒç”¨ 'left' å’Œ 'transform' -->
                                <span class="progress-bar-percentage" style="right: calc(100% - ${album.percentage}%);">
                                    ${album.percentage}%
                                </span>
                                ` : ''}
                            </div>
                        </div>
                        <div id="full-album-content-${index}" class="accordion-content p-3 border-t border-gray-200 text-left">
                                <h4 class="font-semibold text-sm">å·²å¬è¿‡ (${album.heardTracks.length})</h4>
                                <ul class="list-disc list-inside pl-2 text-xs text-green-700">
                                    ${album.heardTracks.length > 0 ? album.heardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">æš‚æ— </li>'}
                                </ul>
                                <h4 class="font-semibold text-sm mt-2">æœªå¬è¿‡ (${album.unheardTracks.length})</h4>
                                <ul class="list-disc list-inside pl-2 text-xs text-gray-400">
                                    ${album.unheardTracks.length > 0 ? album.unheardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">æš‚æ— </li>'}
                                </ul>
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = container.querySelector(header.dataset.target);
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    });
                });
            }


            // --- V3 æ•…äº‹ç‰ˆå¯¼èˆª (Story Navigation) ---

            /**
             * (V3) 1. åˆ›å»ºæ•…äº‹é¡µé¢åºåˆ—
             */
            function createStoryPages(data) {
                storyPages = []; // é‡ç½®
                
                // 1. æ¬¢è¿é¡µ (åŠ è½½é¡µ)
                storyPages.push({ type: 'welcome' });
                
                // 2. æ€»è§ˆé¡µ
                storyPages.push({ type: 'overview', data: data.overview });
                
                // 3. åŸå¸‚ä¸ä¸€åˆ»é¡µ
                storyPages.push({ type: 'city-moments', data: { overview: data.overview, cityMoments: data.cityMoments }});

                // 4. æ­Œæ›²æˆå°±é¡µ (åŠ¨æ€)
                if (data.achievements.length > 0) {
                    data.achievements.forEach(ach => {
                        storyPages.push({ type: 'achievement', data: ach });
                    });
                }
                
                // 5. â€œå…ƒâ€æˆå°±é¡µ (åˆå¹¶)
                if (data.metaAchievements.length > 0) {
                    storyPages.push({ type: 'meta-achievements', data: data.metaAchievements });
                }
                
                // 6. ç¨€æœ‰åº¦ (è¦æ±‚ â‘¢: æ–°çš„ä¸¤ä¸ªé¡µé¢)
                if (data.rarity.totalStatSongs > 0) {
                     storyPages.push({ type: 'rarity-stats', data: data.rarity });
                }
                if (data.rarity.totalListSongs > 0) {
                     storyPages.push({ type: 'rarity-levels', data: data.rarity });
                }

                // 7. ä¸ªäººç‚¹æ­Œé¡µ
                storyPages.push({ type: 'encore', data: data.encore });
                
                // 8. ä¸“è¾‘ç‚¹äº®é¡µ
                storyPages.push({ type: 'albums', data: data.albums });
                
                // 9. æœ€ç»ˆæŠ¥å‘Šå…¥å£é¡µ
                storyPages.push({ type: 'full-report', data: data });

                return storyPages;
            }

            /**
             * (V5 ç¾åŒ– â‘¡) 2. æ¸²æŸ“å½“å‰é¡µé¢ (å·²é‡æ„ä¸ºè¿”å› page)
             */
            function renderCurrentPage() {
                const pageData = storyPages[currentPageIndex];
                
                // åˆ›å»ºæ–°é¡µé¢
                const page = document.createElement('div');
                page.className = 'story-page';
                // (V5.2 ä¿®å¤ Bug â‘ )
                page.dataset.pageType = pageData.type; 
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¯æ»šåŠ¨é¡µé¢
                const isScrollable = [
                    'albums', 
                    'rarity-stats', 
                    'rarity-levels', 
                    'encore',
                    'city-moments', 
                    'achievement', 
                    'meta-achievements'
                ].includes(pageData.type);

                if (isScrollable) {
                    page.classList.add('scrollable');
                    page.style.position = 'relative'; 
                    storyContainer.style.height = 'auto';
                    storyContainer.style.overflow = 'visible';
                    storyContainer.style.maxHeight = 'none';
                } else {
                    page.style.position = 'absolute';
                    storyContainer.style.height = '100vh';
                    storyContainer.style.overflow = 'hidden';
                    storyContainer.style.maxHeight = '100svh';
                }
                
                // æ ¹æ®ç±»å‹å¡«å……å†…å®¹ (è·¯ç”±)
                switch (pageData.type) {
                    case 'welcome':
                        renderWelcomePage(page, pageData.data);
                        break;
                    case 'overview':
                        renderOverviewPage(page, pageData.data);
                        break;
                    case 'city-moments':
                        renderCityMoments(page, pageData.data);
                        break;
                    case 'achievement':
                        renderAchievementPage(page, pageData.data);
                        break;
                    case 'meta-achievements':
                        renderMetaAchievementPage(page, pageData.data);
                        break;
                    case 'rarity-stats': 
                        renderRarityStatsPage(page, pageData.data);
                        break;
                    case 'rarity-levels':
                        renderRarityLevelsPage(page, pageData.data);
                        break;
                    case 'encore':
                        renderEncorePage(page, pageData.data);
                        break;
                    case 'albums':
                        renderAlbumPage(page, pageData.data);
                        break;
                    case 'full-report':
                        renderFullReport(page, pageData.data);
                        break;
                }
                
                // (V5 ç¾åŒ– â‘¡) ä¸åœ¨æ­¤å¤„é™„åŠ æˆ–æ¿€æ´»ï¼Œåªè¿”å› page
                return page;
            }

            /**
             * (V3 æ–°å¢) 3. æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
             */
            function updateNavButtons() {
                // æ¬¢è¿é¡µ (åŠ è½½é¡µ) éšè—å¯¼èˆª
                if (storyPages[currentPageIndex].type === 'welcome') {
                    storyNav.style.display = 'none';
                    return;
                }
                // (!!! ä¿®å¤ !!!) æœ€ç»ˆæŠ¥å‘Šå…¥å£é¡µä¹Ÿéšè—å¯¼èˆª
                if (storyPages[currentPageIndex].type === 'full-report') {
                    storyNav.style.display = 'none';
                    return;
                }
                
                storyNav.style.display = 'flex';
                prevBtn.style.display = (currentPageIndex === 0 || currentPageIndex === 1) ? 'none' : 'block'; // ç¬¬ä¸€é¡µ(æ¬¢è¿)å’Œç¬¬äºŒé¡µ(æ€»è§ˆ)ä¸æ˜¾ç¤º"ä¸Šä¸€é¡µ"
                nextBtn.style.display = (currentPageIndex === storyPages.length - 1) ? 'none' : 'block'; // æœ€åä¸€é¡µä¸æ˜¾ç¤º"ä¸‹ä¸€é¡µ"
            }

            /**
             * (V5 ç¾åŒ– â‘¡) 4. å¯¼èˆªé€»è¾‘ (å·²é‡æ„)
             */
            function changePage(direction) {
                // (V4 ä¿®æ”¹) åœ¨ç¿»é¡µæ—¶ï¼Œä¿å­˜æƒŠå–œæ­Œæ›²
                if (direction > 0 && storyPages[currentPageIndex].type === 'rarity-levels') {
                    // ä» L1-L4 é¡µé¢æ”¶é›†æƒŠå–œæ­Œæ›²
                    const checks = storyContainer.querySelectorAll('.surprise-song-check:checked');
                    surpriseSongs = new Set(Array.from(checks).map(c => c.dataset.songName));
                    // (å®æ—¶æ›´æ–°æœ€ç»ˆæŠ¥å‘Š)
                    if (allReportData.encore) {
                        renderFullReportEncore(allReportData.encore, [...surpriseSongs]);
                    }
                }

                const newIndex = currentPageIndex + direction;
                if (newIndex < 0 || newIndex >= storyPages.length) return; // è¶Šç•Œæ£€æŸ¥
                
                const oldPage = storyContainer.querySelector('.story-page.active');
                
                currentPageIndex = newIndex;
                const newPage = renderCurrentPage(); // åˆ›å»ºæ–°é¡µé¢

                // (V5 ç¾åŒ– â‘¡) æ‰§è¡Œç¿»é¡µåŠ¨ç”»
                if (oldPage) {
                    oldPage.classList.remove('active');

                    // (V5.2 ä¿®å¤ Bug â‘ ) æ¬¢è¿é¡µ(page 0)ç‰¹æ®Šå¤„ç†ï¼šç«‹å³ç§»é™¤ï¼Œä¸æ»‘åŠ¨
                    if (oldPage.dataset.pageType === 'welcome') {
                        oldPage.remove();
                    } else {
                        oldPage.classList.add(direction > 0 ? 'slide-out-to-left' : 'slide-out-to-right');
                        setTimeout(() => {
                            oldPage.remove(); // åŠ¨ç”»ç»“æŸåç§»é™¤æ—§é¡µé¢
                        }, 500); // å¿…é¡»åŒ¹é… CSS åŠ¨ç”»æ—¶é—´
                    }
                }
                
                // (V5.2 ä¿®å¤ Bug â‘ ) æ¬¢è¿é¡µ(page 0) -> æ€»è§ˆé¡µ(page 1)çš„è¿‡æ¸¡ï¼šä½¿ç”¨æ·¡å…¥ï¼Œä¸æ»‘åŠ¨
                if (newPage.dataset.pageType === 'overview' && oldPage?.dataset.pageType === 'welcome') {
                    newPage.style.animation = 'fadeIn 0.5s ease-out forwards';
                } else {
                    newPage.classList.add(direction > 0 ? 'slide-in-from-right' : 'slide-in-from-left');
                }
                
                storyContainer.appendChild(newPage);
                
                // å¼ºåˆ¶é‡ç»˜ä»¥å¯åŠ¨åŠ¨ç”»
                void newPage.offsetWidth; 
                
                // æ¿€æ´»æ–°é¡µé¢ (è§¦å‘ 'active' æ ·å¼)
                newPage.classList.add('active');
                // (V5.1 ä¿®å¤) åŠ¨ç”»ç»“æŸåç§»é™¤ 'slide-in' ç±»ï¼Œé˜²æ­¢å›é€€æ—¶å‡ºé”™
                setTimeout(() => {
                    newPage.classList.remove('slide-in-from-right', 'slide-in-from-left');
                }, 500);
                
                updateNavButtons();

                // å¦‚æœæ˜¯å¯æ»šåŠ¨é¡µé¢ï¼Œæ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
                if (newPage.classList.contains('scrollable')) {
                    window.scrollTo(0, 0);
                }
            }


            // --- Gemini API (è¦æ±‚ â‘ : ä¿æŒæ³¨é‡Š) ---
            
            /*
            async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            }
            */
            
            /*
            async function callGeminiAPI(report) {
                geminiGenerateBtn.style.display = 'none';
                geminiOutput.style.display = 'none';
                geminiLoading.style.display = 'block';

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                // æ„å»ºæç¤ºè¯
                let prompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„è‹æ‰“ç»¿ä¹è¿·å’Œæƒ…æ„Ÿæ–‡æ¡ˆä½œå®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç”¨æˆ·â€œäºŒåå¹´ä¸€åˆ»â€çš„è§‚æ¼”æ•°æ®ï¼Œä¸ºTAæ’°å†™ä¸€æ®µçº¦200å­—çš„ã€ä¸“å±çš„ã€å……æ»¡è¯—æ„å’Œæƒ…æ„Ÿçš„è§‚æ¼”æ€»ç»“ã€‚
                
                è§„åˆ™ï¼š
                1. å¿…é¡»ä½¿ç”¨ä¸­æ–‡ã€‚
                2. é£æ ¼è¦è´´åˆè‹æ‰“ç»¿çš„æ­Œè¯æ°”è´¨ï¼Œæ–‡è‰ºã€æ¸©æŸ”ã€æœ‰åŠ›é‡ã€‚
                3. **å¿…é¡»è‡ªç„¶åœ°**èåˆä»¥ä¸‹æ•°æ®ï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬åœ°ç½—åˆ—ï¼š
                
                ç”¨æˆ·æ•°æ®ï¼š
                - è§‚æ¼”åœºæ¬¡: ${report.overview.totalShows} åœº
                - è§‚æ¼”åŸå¸‚: ${report.overview.uniqueCities.join('ã€')}
                - è§£é”çš„æˆå°±: ${report.achievements.length > 0 ? report.achievements.map(a => `â€œ${a.title}â€`).join(', ') : 'æš‚æ— '}
                - æœ€ç¨€æœ‰çš„â€œç»ç‰ˆä¸€åˆ»â€æ­Œæ›²: ${report.rarity.level1.length > 0 ? report.rarity.level1[0] : 'æš‚æ— '}
                - å¬è¿‡æœ€å¤šæ¬¡çš„ç‚¹æ­Œ (å¸¸å¬æ›²ç›®): ${report.encore.top3.length > 0 ? `${report.encore.top3[0].name} (${report.encore.top3[0].count}æ¬¡)` : 'æš‚æ— '}

                è¯·ç›´æ¥å¼€å§‹æ’°å†™è¿™ç¯‡æ€»ç»“ã€‚`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                try {
                    const result = await fetchWithRetry(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.JSON.stringify(payload)
                    });
                    
                    const text = result.candidates[0].content.parts[0].text;
                    geminiOutput.textContent = text;
                    geminiOutput.style.display = 'block';
                } catch (error) {
                    geminiOutput.textContent = 'ç”Ÿæˆä¸“å±å›å¿†å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
                    geminiOutput.style.display = 'block';
                    geminiGenerateBtn.style.display = 'block';
                } finally {
                    geminiLoading.style.display = 'none';
                }
            }
            */

            // (V5.3 éœ€æ±‚ â‘ ) ä¿å­˜ä¸ºå›¾ç‰‡çš„åŠŸèƒ½
            // (V5.4 ä¿®å¤) è§£å†³ html2canvas æ¸²æŸ“ transition/text-align é”™è¯¯
            function saveReportAsImage() {
                const reportElement = document.getElementById('full-report-page');
                const saveBtn = document.getElementById('save-as-image-btn');
                const resetBtn = document.getElementById('reset-btn');
                // (V5.4 ä¿®å¤) è·å–ä¸´æ—¶æ ·å¼è¡¨
                const tempStyles = document.getElementById('screenshot-fix-styles');

                // 1. æš‚æ—¶éšè—æŒ‰é’®ï¼Œä»¥å…å‡ºç°åœ¨æˆªå›¾ä¸­
                if (saveBtn) saveBtn.style.display = 'none';
                if (resetBtn) resetBtn.style.display = 'none';
                
                // (V5.4 ä¿®å¤) æ³¨å…¥ CSS ä¿®å¤: ç¦ç”¨ transitionï¼Œé˜²æ­¢ html2canvas æ¸²æŸ“é”™è¯¯
                if (tempStyles) {
                    tempStyles.innerHTML = `
                        .progress-bar-fill {
                            transition: none !important;
                        }
                        /* (V5.5 ä¿®å¤) ç¡®ä¿æ–°spançš„leftå±æ€§ä¹Ÿè¢«ç«‹å³åº”ç”¨ */
                        .progress-bar-percentage {
                            transition: none !important;
                        }
                    `;
                }
                
                // å¼¹å‡ºåŠ è½½æç¤º
                showAlert('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...'); 

                // (V5.4 ä¿®å¤) å¢åŠ ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿï¼Œç¡®ä¿ CSS ä¿®å¤è¢«æµè§ˆå™¨åº”ç”¨
                setTimeout(() => {
                    html2canvas(reportElement, {
                        // ä½¿ç”¨ --theme-bg ä½œä¸ºèƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€æ˜
                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--theme-bg') || '#f4f8f4',
                        scale: 2 // 2å€åˆ†è¾¨ç‡ï¼Œä½¿å›¾ç‰‡æ›´æ¸…æ™°
                    }).then(canvas => {
                        // åˆ›å»ºä¸€ä¸ªé“¾æ¥æ¥è§¦å‘ä¸‹è½½
                        const link = document.createElement('a');
                        link.download = 'summary-sodagreen-20th-anniversary.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        link.remove(); // æ¸…ç†
                        
                        // 2. æ¢å¤æŒ‰é’®æ˜¾ç¤º
                        if (saveBtn) saveBtn.style.display = 'block';
                        if (resetBtn) resetBtn.style.display = 'block';
                        
                        // (V5.4 ä¿®å¤) æ¸…ç©ºä¸´æ—¶æ ·å¼
                        if (tempStyles) tempStyles.innerHTML = '';
                        
                        // å…³é—­åŠ è½½æç¤º
                        closeAlert(); 
                    }).catch(err => {
                        console.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥:', err);
                        // 2. å³ä½¿å¤±è´¥ä¹Ÿè¦æ¢å¤æŒ‰é’®
                        if (saveBtn) saveBtn.style.display = 'block';
                        if (resetBtn) resetBtn.style.display = 'block';
                        
                        // (V5.4 ä¿®å¤) æ¸…ç©ºä¸´æ—¶æ ·å¼
                        if (tempStyles) tempStyles.innerHTML = '';
                        
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        showAlert('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                    });
                }, 100); // å¢åŠ  100ms å»¶è¿Ÿç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
            }

            /**
             * (V3) ä¸»å‡½æ•°ï¼šç”ŸæˆæŠ¥å‘Š
             */
            function generateReport() {
                // 1. è·å–è¾“å…¥
                const userShowIDs = getSelectedShowIDs();
                
                if (userShowIDs.length === 0) {
                    showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºæ¬¡');
                    return;
                }
                
                // 2. åˆ‡æ¢åˆ°æ•…äº‹é¡µ
                selectionPage.style.display = 'none';
                storyContainer.style.display = 'block';
                
                // (V5.1 ä¿®å¤) åˆå§‹åŒ– storyPages ä»¥æ¸²æŸ“æ¬¢è¿é¡µ
                storyPages = [{ type: 'welcome' }];
                currentPageIndex = 0; // ä»æ¬¢è¿é¡µå¼€å§‹
                
                // (V5 ç¾åŒ– â‘¡) æ¸²æŸ“ç¬¬ä¸€é¡µ (æ¬¢è¿é¡µ)ï¼Œä¸ä½¿ç”¨ changePage
                const welcomePage = renderCurrentPage();
                storyContainer.appendChild(welcomePage);
                welcomePage.classList.add('active'); // ç›´æ¥æ¿€æ´»ï¼Œæ— åŠ¨ç”»
                updateNavButtons();
                
                // 3. (å¼‚æ­¥) å¯åŠ¨è®¡ç®—
                // ç”¨ setTimeout ç¡®ä¿æ¬¢è¿é¡µ(åŠ è½½é¡µ)èƒ½å…ˆæ¸²æŸ“å‡ºæ¥
                setTimeout(() => {
                    // (F2) ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰æ•°æ®
                    const selectedShows = getSelectedShows(userShowIDs);
                    const { uniqueSongs, uniqueEncoreSongs, encoreSongsWithDuplicates } = getCompleteUserSongList(userShowIDs, selectedShows);
                    
                    const overviewData = calculateOverview(userShowIDs, selectedShows);
                    
                    const { songAchievements, metaAchievements } = calculateAchievements(userShowIDs, selectedShows, overviewData.totalCities);
                    
                    allReportData = {
                        overview: overviewData,
                        cityMoments: calculateCityMoments(selectedShows),
                        albums: calculateAlbumProgress(uniqueSongs),
                        encore: calculateEncoreStats(encoreSongsWithDuplicates),
                        rarity: calculateRarity(uniqueEncoreSongs, userShowIDs),
                        achievements: songAchievements, 
                        metaAchievements: metaAchievements,
                        allAchievements: [...songAchievements, ...metaAchievements].sort((a,b) => a.id.startsWith('meta_') ? 1 : -1)
                    };

                    // (V3) ç”Ÿæˆæ•…äº‹é¡µé¢åºåˆ—
                    storyPages = createStoryPages(allReportData);
                    
                    // 4. è®¡ç®—å®Œæˆï¼Œè·³è½¬åˆ°ä¸‹ä¸€é¡µ (æ€»è§ˆé¡µ)
                    // (V5 ç¾åŒ– â‘¡) ä½¿ç”¨ changePage è§¦å‘æ»‘åŠ¨
                    changePage(1); // è·³è½¬åˆ°æ€»è§ˆé¡µ
                    
                }, 500); // ç»™ 0.5 ç§’æ˜¾ç¤ºâ€œæ­£åœ¨ç”Ÿæˆâ€
            }
            
            // --- ç»‘å®šäº‹ä»¶ ---
            
            // V4 ä¿®æ”¹: DOMContentLoaded ç°åœ¨åªç”¨äºå¯åŠ¨æ•°æ®åŠ è½½
            initializeApp();
            
            // V3 å¯¼èˆªäº‹ä»¶
            prevBtn.addEventListener('click', () => changePage(-1));
            nextBtn.addEventListener('click', () => changePage(1));

            // (V5.3 éœ€æ±‚ â‘ ) ç»‘å®šä¿å­˜å›¾ç‰‡æŒ‰é’®
            if (saveAsImageBtn) {
                saveAsImageBtn.addEventListener('click', saveReportAsImage);
            }
            
            // (è¦æ±‚ â‘¢) æ–°å¢: ä¸ºæƒŠå–œæ­Œæ›²å¤é€‰æ¡†æ·»åŠ äº‹ä»¶å§”æ‰˜
            storyContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('surprise-song-check')) {
                    const songName = e.target.dataset.songName;
                    if (e.target.checked) {
                        surpriseSongs.add(songName);
                    } else {
                        surpriseSongs.delete(songName);
                    }
                    // (!!!) å®æ—¶æ›´æ–°æœ€ç»ˆæŠ¥å‘Šé¡µçš„æ•°æ®
                    if (allReportData.encore) {
                        renderFullReportEncore(allReportData.encore, [...surpriseSongs]);
                    }
                }
            });
            
            // æœ€ç»ˆæŠ¥å‘Šé¡µçš„é‡ç½®æŒ‰é’®
            resetBtn.addEventListener('click', () => {
                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                fullReportPage.style.display = 'none';
                selectionPage.style.display = 'block';
                allReportData = {};
                storyPages = [];
                currentPageIndex = 0;
                surpriseSongs.clear(); // (è¦æ±‚ â‘¢) é‡ç½®æƒŠå–œæ­Œæ›²
                
                // (è¦æ±‚ â‘ : ä¿æŒæ³¨é‡Š)
                // é‡ç½® Gemini æ¨¡å—
                // geminiOutput.style.display = 'none';
                // geminiOutput.textContent = '';
                // geminiGenerateBtn.style.display = 'block';
                
                // é‡ç½®é€‰æ‹©æ¡†
                document.querySelectorAll('.show-checkbox:checked').forEach(box => box.checked = false);
                document.querySelectorAll('.accordion-content.open').forEach(content => content.classList.remove('open'));
                document.querySelectorAll('.accordion-header.open').forEach(header => header.classList.remove('open'));
                
                window.scrollTo(0, 0);
            });
            
            // Modal äº‹ä»¶
            modalCloseBtn.addEventListener('click', closeAlert);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeAlert();
            });
            
            // (è¦æ±‚ â‘ : ä¿æŒæ³¨é‡Š)
            // Gemini æŒ‰é’®äº‹ä»¶
            /*
            geminiGenerateBtn.addEventListener('click', () => {
                // ç¡®ä¿ allReportData å·²å¡«å……
                if (allReportData.overview) {
                    callGeminiAPI(allReportData);
                }
            });
            */
        });
    </script>
</body>
</html>
