<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苏打绿“二十年一刻”观演总结</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 定义主题颜色 */
        :root {
            --theme-bg: #f4f8f4; /* 淡淡的绿色背景 */
            --theme-text: #22543d; /* 深绿色文本 */
            --theme-primary: #48bb78; /* 绿色 */
            --theme-primary-dark: #38a169;
            --theme-accent-bg: #fefcbf; /* 亮黄色 (成就) */
            --theme-accent-border: #f6e05e;
            --theme-card-bg: #ffffff;
            --theme-border: #e2e8f0;
        }

        /* 基础样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-image: linear-gradient(180deg, #f8fcf8, var(--theme-bg));
            color: var(--theme-text);
            overscroll-behavior: none;
            position: relative;
            z-index: 1;
        }
        
        /* (V5 美化 ④) 背景水印 */
        body::before {
            content: 'S O D A G R E E N';
            position: fixed; /* 固定在视口 */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            font-size: 6rem; /* 调整水印大小 */
            font-weight: 900;
            color: rgba(34, 84, 61, 0.03); /* 3% 透明度的绿色 */
            letter-spacing: 0.5rem;
            z-index: -10; /* 确保在所有内容之下 */
            pointer-events: none; /* 防止遮挡点击 */
        }

        /* ------------------------- */
        /* V3 故事版 (Story) 样式    */
        /* ------------------------- */
        #story-container {
            width: 100%;
            height: 100vh;
            max-height: 100svh; /* 适配移动端 */
            overflow: hidden; 
            position: relative;
        }

        .story-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent; /* (V5 美化 ③) 改为透明，让 body 渐变透出来 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            z-index: 5; /* 默认在下层 */
        }
        
        .story-page.scrollable {
            justify-content: flex-start;
            padding-bottom: 8rem; /* 为导航按钮留出空间 */
            height: auto; /* 覆盖 .story-page 的 100% 高度 */
            min-height: 100vh; /* 至少占满一屏 */
        }

        .story-page.active {
            opacity: 1;
            visibility: visible;
            z-index: 10; /* 激活的页面在上层 */
        }

        /* (V5 美化 ②) 翻页动画 */
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slideInFromLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .slide-in-from-right { animation: slideInFromRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-out-to-left { animation: slideOutToLeft 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-in-from-left { animation: slideInFromLeft 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-out-to-right { animation: slideOutToRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }


        /* 导航按钮 */
        #story-nav {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 1rem;
        }
        
        .story-nav-btn {
            background-color: var(--theme-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 4px 14px 0 rgba(0,0,0,0.1);
        }
        .story-nav-btn:hover {
            background-color: var(--theme-primary-dark);
        }
        
        /* ------------------------- */
        /* V3/V4/V5 美化样式         */
        /* ------------------------- */

        /* (V5 美化 ①) 加载动画 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loader-spinner {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border: 4px solid rgba(34, 84, 61, 0.1); /* --theme-text with 10% opacity */
            border-top-color: var(--theme-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }


        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* (V4.2 新增) 要求 ①: 分段淡出动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-item-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; /* 动画开始前隐藏 */
        }
        
        @keyframes sequentialFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .meta-ach-card {
            animation: sequentialFadeIn 0.6s ease-out forwards;
            opacity: 0; /* Start hidden */
            margin-bottom: 2rem;
            width: 100%;
            max-width: 500px;
        }

        /* 城市气泡 (要求 ①) */
        .city-bubble {
            display: inline-block;
            background-color: var(--theme-card-bg);
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 99px;
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        /* 故事页通用标题 */
        .story-title {
            font-size: 1.875rem; /* 30px */
            font-weight: 700;
            /* (V5 美化 ③) 渐变标题 */
            background: linear-gradient(45deg, var(--theme-text), var(--theme-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--theme-text); /* Fallback */
            margin-bottom: 1.5rem; /* 24px */
        }
        .story-subtitle {
            font-size: 1.125rem; /* 18px */
            color: var(--theme-text);
            opacity: 0.8;
            margin-bottom: 2rem;
        }

        /* 成就故事页美化 (要求 ②) */
        .story-ach-title {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
            /* (V5 美化 ③) 渐变标题 */
            background: linear-gradient(45deg, var(--theme-primary-dark), var(--theme-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: var(--theme-primary); /* Fallback */
            margin-bottom: 1rem;
        }
        .story-ach-desc {
            font-size: 1.125rem; /* 18px */
            font-style: italic;
            color: var(--theme-text);
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        .story-ach-details {
            background-color: var(--theme-card-bg);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--theme-border);
        }
        .story-ach-details .details-title {
            font-weight: 600;
            color: var(--theme-text);
            border-bottom: 1px dashed var(--theme-primary);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem; /* 增加了间距 */
        }
        
        /* (V4.2 新增) 要求 ②: 时间轴样式 */
        .timeline-container {
            position: relative;
            padding-left: 2rem; /* 为时间轴线和点留出空间 */
        }
        .timeline-line {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--theme-primary);
            opacity: 0.3;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-dot {
            position: absolute;
            left: -2.4rem; /* (2rem padding) - (0.4rem dot size / 2) */
            top: 0.3rem;
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 50%;
            background-color: var(--theme-primary);
            border: 2px solid var(--theme-bg);
        }
        .timeline-content {
            text-align: left;
        }
        .timeline-date {
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            color: var(--theme-text);
        }
        .timeline-city {
            font-weight: 500;
            font-size: 1rem; /* 16px */
            color: var(--theme-text);
        }
        .timeline-songs {
            font-size: 0.875rem;
            color: var(--theme-text);
            opacity: 0.7;
        }

        /* (V4.2 新增) 要求 ③: 重逢卡片样式 */
        .reunion-container {
            width: 100%;
            space-y: 0.5rem;
        }
        .reunion-card {
            background-color: var(--theme-bg);
            border: 1px solid var(--theme-border);
            border-left: 4px solid var(--theme-primary);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: left;
            margin-bottom: 0.75rem;
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        .reunion-card h3 {
            font-weight: 600;
            font-size: 1rem;
            color: var(--theme-text);
        }
        .reunion-card p {
            font-size: 0.875rem;
            color: var(--theme-text);
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        .reunion-card p strong {
            color: var(--theme-primary);
            font-weight: 600;
        }


        /* ------------------------- */
        /* V1/V2 原始样式 (保留)     */
        /* ------------------------- */
        
        /* 折叠菜单样式 */
        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: rgba(0,0,0,0.03);
        }
        .accordion-content {
            display: none; /* 默认隐藏 */
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }
        .accordion-content.open {
            display: block;
            max-height: 1000px; /* 足够大的高度 */
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.open .accordion-icon {
            transform: rotate(90deg);
        }
        
        /* (V4.1 新增) 全选按钮样式 */
        .select-all-btn {
            font-size: 0.75rem; /* 12px */
            padding: 0.1rem 0.5rem;
            border-radius: 99px;
            background-color: var(--theme-bg);
            border: 1px solid var(--theme-primary);
            color: var(--theme-primary);
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 0.5rem;
        }
        .select-all-btn:hover {
            background-color: #e6f7eb;
        }


        /* 报告卡片样式 */
        .report-card {
            background-color: var(--theme-card-bg);
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--theme-border);
            overflow: hidden;
        }
        
        /* 进度条样式 */
        .progress-bar-bg {
            background-color: #e2e8f0;
            border-radius: 0.375rem; /* 6px */
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: var(--theme-primary);
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding: 0 0.5rem;
            color: white;
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
        }
        
        /* 成就卡片 (用于最终报告页) */
        .achievement-card {
            background-color: var(--theme-accent-bg);
            border: 1px solid var(--theme-accent-border);
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .achievement-card .title {
            color: #b7791f; /* 深黄褐色 */
            font-weight: 600;
        }
        .achievement-card .description {
            color: #744210; /* 褐色 */
        }
        .achievement-card .details {
            border-top: 1px dashed #d69e2e; /* 黄褐色虚线 */
        }
        
        /* 自定义 Modal 弹窗 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-box {
            background-color: white;
            padding: 1.5rem; /* 24px */
            border-radius: 0.5rem; /* 8px */
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        <div id="selection-page" class="relative">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold" style="color: var(--theme-text);">苏打绿“二十年一刻”</h1>
                <p class="text-xl mt-1" style="color: var(--theme-text);">专属观演总结</p>
            </header>

            <main class="report-card p-4 md:p-6">
                <h2 class="font-semibold text-lg mb-4 text-center">请选择你观演过的场次</h2>
                
                <div id="accordion-container" class="space-y-2">
                    <div id="data-loading-spinner" class="loader-container">
                        <div class="loader-spinner"></div>
                    </div>
                </div>

                <button id="generate-report-btn" class="w-full mt-6 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200" style="background-color: var(--theme-primary);" disabled>
                    请稍候...
                </button>
            </main>
        </div>

        <div id="story-container" style="display: none;">
            <div id="story-nav" style="display: none;">
                <button id="prev-btn" class="story-nav-btn">上一页</button>
                <button id="next-btn" class="story-nav-btn">下一页</button>
            </div>
        </div>


        <div id="full-report-page" class="relative" style="display: none;">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold" style="color: var(--theme-text);">我的专属观演报告</h1>
                <p class="text-sm" style="color: var(--theme-text);">(我的完整旅程总览)</p>
            </header>

            <div class="space-y-6">
                
                <section class="report-card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">🗺️ 我的“二十年一刻”总览</h2>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div id="full-total-shows" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">总场次</div>
                            </div>
                            <div>
                                <div id="full-total-hours" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">总时长 (h)</div>
                            </div>
                            <div>
                                <div id="full-total-cities" class="text-4xl font-bold" style="color: var(--theme-primary);">0</div>
                                <div class="text-sm mt-1">总城市</div>
                            </div>
                        </div>
                        <div id="full-city-list" class="mt-4 text-center text-sm">
                            </div>
                    </div>
                </section>
                
                <section class="report-card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">🎖️ 我的成就墙</h2>
                        <div id="full-achievement-grid" class="space-y-3">
                            </div>
                    </div>
                </section>

                <section class="report-card" id="full-rarity-grid">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">💎 我的点歌稀有度</h2>
                        <div class="grid grid-cols-3 gap-4 text-center mb-4">
                            <div>
                                <div id="full-rarity-first" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">巡演起点</div>
                            </div>
                            <div>
                                <div id="full-rarity-last" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">巡演终点</div>
                            </div>
                            <div>
                                <div id="full-rarity-total-songs" class="text-3xl font-bold">0</div>
                                <div class="text-sm mt-1">点歌总数</div>
                            </div>
                        </div>
                        
                        <div id="full-rarity-levels" class="mt-4 pt-4 border-t border-gray-200">
                             <h3 class="font-semibold text-center mb-2">分级总览</h3>
                             <div class="grid grid-cols-4 gap-2 text-center">
                                 <div>
                                    <div id="full-rarity-l1-count" class="text-2xl font-bold">0</div>
                                    <div class="text-xs mt-1">绝版一刻</div>
                                 </div>
                                 <div>
                                    <div id="full-rarity-l2-count" class="text-2xl font-bold">0</div>
                                    <div class="text-xs mt-1">限定重逢</div>
                                 </div>
                                 <div>
                                    <div id="full-rarity-l3-count" class="text-2xl font-bold">0</div>
                                    <div class="text-xs mt-1">珍贵相遇</div>
                                 </div>
                                 <div>
                                    <div id="full-rarity-l4-count" class="text-2xl font-bold">0</div>
                                    <div class="text-xs mt-1">热门回响</div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </section>

                <section class="report-card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">🎶 我的个人点歌细节</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="font-semibold text-lg mb-2">我的常听曲目 Top 3</h3>
                                <ul id="full-encore-top3" class="list-decimal list-inside space-y-1">
                                </ul>
                            </div>
                             <div>
                                <h3 class="font-semibold text-lg mb-2">我的宝藏歌曲</h3>
                                <ul id="full-encore-once" class="list-disc list-inside space-y-1">
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="report-card">
                    <div class="p-5">
                        <h2 class="text-2xl font-semibold mb-4 text-center">💿 专辑点亮计划</h2>
                        <div id="full-album-progress-grid" class="space-y-3">
                            </div>
                    </div>
                </section>
                
                <button id="reset-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors duration-200 hover:bg-gray-300">
                    返回首页重新选择
                </button>
            </div>
        </div>

        <footer class="text-center mt-8 pb-4 relative z-10">
            <p class="text-xs text-gray-400">
                如果有任何bug请向 @见春风起意 反馈
            </p>
        </footer>

    </div>

    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box text-center">
            <p id="modal-message" class="text-lg text-gray-700">这是一条提示信息。</p>
            <button id="modal-close-btn" class="w-full mt-4 text-white font-bold py-2 px-4 rounded-lg" style="background-color: var(--theme-primary);">
                好的
            </button>
        </div>
    </div>


    <script>
        // =================================================================
        //
        //  1. 核心数据 (PRD V2.2)
        //  V4 修改: 数据已分离到 data.json, 此处仅为变量声明
        //
        // =================================================================
        
        let concertList = [];
        let discography = [];
        let tourData = {};
        let songRarityDB = {};
        let achievementDB = [];
        let allCityExclusiveSongs = [];
        let allUnreleasedSongs = [];
        // (V4.2 新增) 要求 ③: 反向映射表
        let citySongReverseMap = {};


        // =================================================================
        //
        //  2. 应用程序逻辑 (Application Logic)
        //
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 页面元素 ---
            const selectionPage = document.getElementById('selection-page');
            const storyContainer = document.getElementById('story-container');
            const storyNav = document.getElementById('story-nav');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const fullReportPage = document.getElementById('full-report-page');
            const accordionContainer = document.getElementById('accordion-container');
            // (V5 美化 ①) 修改加载占位符
            const dataLoadingSpinner = document.getElementById('data-loading-spinner');
            const generateBtn = document.getElementById('generate-report-btn');
            const resetBtn = document.getElementById('reset-btn');
            const modal = document.getElementById('alert-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            // const geminiGenerateBtn = document.getElementById('gemini-generate-btn');
            // const geminiLoading = document.getElementById('gemini-loading');
            // const geminiOutput = document.getElementById('gemini-output');

            // --- V3 故事版状态 ---
            let allReportData = {}; // 存储所有计算结果
            let storyPages = [];     // 故事页面序列
            let currentPageIndex = 0;
            let surpriseSongs = new Set(); // (要求 ③) 新增: 存储惊喜歌曲

            // --- 页面初始化 (V4 修改: 异步加载数据) ---
            
            async function initializeApp() {
                try {
                    // 1. 异步获取数据
                    // (V4.1 修复: 路径指向根目录)
                    const response = await fetch('data.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // 2. 填充全局数据变量
                    concertList = data.concertList || [];
                    discography = data.discography || [];
                    tourData = data.tourData || {};
                    songRarityDB = data.songRarityDB || {};
                    achievementDB = data.achievementDB || [];
                    allCityExclusiveSongs = data.allCityExclusiveSongs || [];
                    allUnreleasedSongs = data.allUnreleasedSongs || [];

                    // (V4.2 新增) 要求 ③: 建立城市限定歌反向映射表 (用于 "重逢的一刻")
                    for (const city in tourData.citySongs) {
                        const song = tourData.citySongs[city];
                        if (song) {
                            citySongReverseMap[song] = city;
                        }
                    }

                    // 3. 渲染页面
                    // (V5 美化 ①) 隐藏加载动画
                    dataLoadingSpinner.style.display = 'none'; 
                    renderAccordion(); // 使用刚加载的数据构建菜单
                    
                    // 4. 激活按钮
                    generateBtn.disabled = false;
                    generateBtn.textContent = '生成我的观演报告';
                    
                    // 5. 绑定核心事件
                    generateBtn.addEventListener('click', generateReport);

                } catch (error) {
                    console.error('Failed to load core data:', error);
                    // (V5 美化 ①) 修改错误提示
                    dataLoadingSpinner.innerHTML = '<p class="text-center text-red-600">场次数据加载失败！<br>请刷新页面重试。</p>';
                    showAlert('核心数据加载失败！请刷新页面重试。');
                }
            }
            
            /**
             * (V4.1 修改) 渲染三级折叠菜单 (F1.1)
             * - 简化“海外地区” (要求 ①)
             * - 添加“全选”按钮 (要求 ②)
             */
            function renderAccordion() {
                const groupedByRegion = concertList.reduce((acc, show) => {
                    (acc[show.region] = acc[show.region] || []).push(show);
                    return acc;
                }, {});

                let html = '';
                const regionsOrder = ['大陆地区', '港台地区', '海外地区'];

                for (const region of regionsOrder) {
                    if (!groupedByRegion[region]) continue;
                    
                    const regionShows = groupedByRegion[region];
                    const regionId = `region-${region.replace(/\s/g, '-')}`;

                    html += `
                        <div class="border border-gray-200 rounded-md">
                            <div id="${regionId}-header" class="accordion-header flex justify-between items-center p-3" data-target="#${regionId}-content">
                                <div class="flex items-center">
                                    <span class="font-semibold text-lg">${region}</span>
                                    <button class="select-all-btn" data-target-id="#${regionId}-content" title="全选/全不选 ${region}">全选</button>
                                </div>
                                <span class="accordion-icon text-gray-500">▶</span>
                            </div>
                            <div id="${regionId}-content" class="accordion-content pl-4 border-t border-gray-200">
                    `;

                    const groupedByCity = regionShows.reduce((acc, show) => {
                        (acc[show.city] = acc[show.city] || []).push(show);
                        return acc;
                    }, {});

                    // --- V4.1: (要求 ①) 简化“海外地区” ---
                    if (region === '海外地区') {
                        // 直接渲染为二级勾选列表
                        regionShows.sort((a, b) => a.order - b.order); // 按日期排序
                        for (const show of regionShows) {
                            html += `
                                <label class="flex items-center space-x-2 cursor-pointer p-3 pl-2 border-b border-gray-100 last:border-b-0">
                                    <input type="checkbox" class="show-checkbox form-checkbox h-5 w-5 rounded" data-id="${show.id}" style="color: var(--theme-primary);">
                                    <span>${show.city} (${show.date})</span>
                                </label>
                            `;
                        }
                    } else {
                        // --- V4.1: (要求 ②) 其他地区保持三级，并添加 L2 全选 ---
                        for (const city in groupedByCity) {
                            const cityShows = groupedByCity[city];
                            const cityId = `city-${city.replace(/\s/g, '-')}`;

                            html += `
                                <div class="border-b border-gray-200 last:border-b-0">
                                    <div id="${cityId}-header" class="accordion-header flex justify-between items-center p-3" data-target="#${cityId}-content">
                                        <div class="flex items-center">
                                            <span class="font-medium">${city}</span>
                                            <button class="select-all-btn" data-target-id="#${cityId}-content" title="全选/全不选 ${city}">全选</button>
                                        </div>
                                        <span class="accordion-icon text-gray-500">▶</span>
                                    </div>
                                    <div id="${cityId}-content" class="accordion-content pl-6 py-2 space-y-2">
                            `;
                            
                            cityShows.sort((a, b) => a.order - b.order);
                            for (const show of cityShows) {
                                html += `
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" class="show-checkbox form-checkbox h-5 w-5 rounded" data-id="${show.id}" style="color: var(--theme-primary);">
                                        <span>${show.name} (${show.date})</span>
                                    </label>
                                `;
                            }
                            html += `</div></div>`;
                        }
                    }
                    html += `</div></div>`;
                }
                accordionContainer.innerHTML = html;
                // V4.1 修改: 调用新的激活函数
                activateAccordionAndSelectAll();
            }

            /**
             * (V4.1 修改) 激活折叠菜单和全选按钮
             * 使用事件委托
             */
            function activateAccordionAndSelectAll() {
                accordionContainer.addEventListener('click', (e) => {
                    const selectAllBtn = e.target.closest('.select-all-btn');
                    const header = e.target.closest('.accordion-header');

                    if (selectAllBtn) {
                        // --- Handle Select All (Request 2) ---
                        e.stopPropagation(); // 阻止折叠菜单展开/关闭
                        const targetId = selectAllBtn.dataset.targetId;
                        const content = document.querySelector(targetId);
                        if (!content) return;

                        const checkboxes = content.querySelectorAll('.show-checkbox');
                        if (checkboxes.length === 0) return;

                        // 核心逻辑: 如果有任何一个没被选中，则全选；否则全不选
                        const shouldCheck = Array.from(checkboxes).some(box => !box.checked);
                        checkboxes.forEach(box => {
                            box.checked = shouldCheck;
                        });
                    
                    } else if (header) {
                        // --- Handle Accordion (Original Logic) ---
                        const content = document.querySelector(header.dataset.target);
                        if (!content) return;
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                });
            }

            /**
             * 显示/关闭自定义弹窗
             */
            function showAlert(message) {
                modalMessage.textContent = message;
                modal.style.display = 'flex';
            }
            function closeAlert() {
                modal.style.display = 'none';
            }
            
            // --- 核心报告生成逻辑 (F2) ---

            function getSelectedShowIDs() {
                return Array.from(document.querySelectorAll('.show-checkbox:checked')).map(box => box.dataset.id);
            }
            
            function getSelectedShows(userShowIDs) {
                 return concertList.filter(show => userShowIDs.includes(show.id));
            }

            function calculateOverview(userShowIDs, selectedShows) {
                const totalShows = userShowIDs.length;
                const totalHours = totalShows * 3;
                const uniqueCities = [...new Set(selectedShows.map(show => show.city))];
                const totalCities = uniqueCities.length;
                const cityListText = totalCities > 0 ? `我的足迹遍布：${uniqueCities.join('、')}` : '我还没有选择任何场次。';
                return { totalShows, totalHours, totalCities, cityListText, uniqueCities };
            }

            // (V3 新增) 计算城市一刻
            function calculateCityMoments(selectedShows) {
                const uniqueCities = [...new Set(selectedShows.map(show => show.city))];
                return uniqueCities.map(city => tourData.citySongs[city]).filter(Boolean); // 过滤掉 undefined
            }

            function getCompleteUserSongList(userShowIDs, selectedShows) {
                let allSongs = new Set();
                let allEncoreSongsWithDuplicates = [];
                let allEncoreSongs = new Set();
                
                if (userShowIDs.length > 0) {
                    tourData.fixedSongs.forEach(song => allSongs.add(song));
                }

                const uniqueCities = new Set(selectedShows.map(show => show.city));
                uniqueCities.forEach(city => {
                    if (tourData.citySongs[city]) {
                        allSongs.add(tourData.citySongs[city]);
                    }
                });

                userShowIDs.forEach(id => {
                    if (tourData.encoreSetlists[id]) {
                        tourData.encoreSetlists[id].forEach(song => {
                            allSongs.add(song);
                            allEncoreSongs.add(song);
                            allEncoreSongsWithDuplicates.push(song);
                        });
                    }
                });

                return {
                    uniqueSongs: allSongs, 
                    uniqueEncoreSongs: allEncoreSongs, 
                    encoreSongsWithDuplicates: allEncoreSongsWithDuplicates
                };
            }

            // (V3 重大修改) F2.3: 计算专辑进度 (返回 heard/unheard 列表)
            function calculateAlbumProgress(userSongsSet) {
                return discography.map(album => {
                    let count = 0;
                    let heardTracks = [];
                    let unheardTracks = [];

                    album.tracks.forEach(track => {
                        const simplifiedTrack = track.replace(/[\s\.]/g, '');
                        const userHasSong = [...userSongsSet].some(userSong => 
                            userSong.replace(/[\s\.]/g, '') === simplifiedTrack
                        );
                        
                        if (userHasSong) {
                            count++;
                            heardTracks.push(track);
                        } else {
                            unheardTracks.push(track);
                        }
                    });
                    
                    const total = album.tracks.length;
                    const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                    
                    return {
                        name: album.albumName,
                        count,
                        total,
                        percentage,
                        heardTracks, // V3 新增
                        unheardTracks // V3 新增
                    };
                });
            }

            // F2.4: 计算个人点歌分析
            function calculateEncoreStats(encoreSongsWithDuplicates) {
                const songCounts = encoreSongsWithDuplicates.reduce((acc, song) => {
                    acc[song] = (acc[song] || 0) + 1;
                    return acc;
                }, {});

                const sortedSongs = Object.entries(songCounts).sort(([, countA], [, countB]) => countB - countA);
                const top3 = sortedSongs.slice(0, 3).map(([name, count]) => ({ name, count }));
                const once = sortedSongs.filter(([, count]) => count === 1).map(([name]) => name);

                return { top3, once };
            }

            // (V3 重大修改) F2.5: 计算稀有度 (返回歌曲列表) (响应要求 ③)
            function calculateRarity(uniqueEncoreSongs, userShowIDs) {
                let rarityFirst = 0, rarityLast = 0, rarityOnly = 0;
                let firstSongsList = [], lastSongsList = [], onlySongsList = [];
                let level1 = [], level2 = [], level3 = [], level4 = [];

                uniqueEncoreSongs.forEach(song => {
                    const rarityInfo = songRarityDB[song];
                    if (!rarityInfo) return;

                    if (userShowIDs.includes(rarityInfo.firstShowId)) {
                        rarityFirst++;
                        firstSongsList.push(song);
                    }
                    if (userShowIDs.includes(rarityInfo.lastShowId)) {
                        rarityLast++;
                        lastSongsList.push(song); 
                    }
                    if (rarityInfo.tourCount === 1) { 
                        rarityOnly++;
                    }

                    if (rarityInfo.tourCount === 1) level1.push(song);
                    else if (rarityInfo.tourCount <= 3) level2.push(song);
                    else if (rarityInfo.tourCount <= 5) level3.push(song);
                    else level4.push(song);
                });
                
                return { 
                    rarityFirst, rarityLast, rarityOnly,
                    firstSongsList: [...new Set(firstSongsList)], // 去重
                    lastSongsList: [...new Set(lastSongsList)],   // 去重
                    onlySongsList: [], 
                    level1, level2, level3, level4,
                    totalListSongs: level1.length + level2.length + level3.length + level4.length,
                    totalStatSongs: rarityFirst + rarityLast + rarityOnly
                };
            }
            
            // F2.6: 计算特殊成就 (拆分歌曲成就和元成就)
            function calculateAchievements(userShowIDs, selectedShows, totalCities) {
                let songAchievements = [];
                let metaAchievements = []; 
                
                const showMap = new Map(selectedShows.map(show => [show.id, show]));
                
                const findSong = (songList, targetSong) => {
                    const simplifiedTarget = targetSong.replace(/[\s\.]/g, '');
                    return songList.some(song => song.replace(/[\s\.]/g, '').includes(simplifiedTarget));
                };

                // 1. 遍历 D5 成就数据库
                achievementDB.forEach(ach => {
                    let unlockedDetails = [];
                    
                    if (ach.type === 'experience') {
                        if (userShowIDs.some(id => ach.triggerShows.includes(id))) {
                            metaAchievements.push({ ...ach });
                        }
                    } else if (ach.type === 'song') {
                        userShowIDs.forEach(id => {
                            if (ach.triggerMap[id]) {
                                const show = showMap.get(id);
                                const triggeredSongs = ach.triggerMap[id];
                                
                                const songsThisShow = [...new Set([
                                    ...tourData.fixedSongs,
                                    ...(tourData.citySongs[show.city] ? [tourData.citySongs[show.city]] : []),
                                    ...(tourData.encoreSetlists[id] || [])
                                ])];
                                
                                const matchedSongs = triggeredSongs.filter(ts => findSong(songsThisShow, ts));
                                
                                if (matchedSongs.length > 0) {
                                     unlockedDetails.push({
                                        date: show.date,
                                        city: show.city,
                                        songs: matchedSongs
                                    });
                                }
                            }
                        });
                        
                        if (unlockedDetails.length > 0) {
                            songAchievements.push({ ...ach, details: unlockedDetails });
                        }
                    }
                });
                
                // 2. 计算 'ach_reunion' (重逢的一刻)
                let reunionDetails = [];
                selectedShows.forEach(show => {
                    const city = show.city;
                    const id = show.id;
                    const nativeCitySong = tourData.citySongs[city];
                    const encore = tourData.encoreSetlists[id] || [];
                    
                    const reunionSongs = encore.filter(song => 
                        allCityExclusiveSongs.includes(song) && song !== nativeCitySong
                    );
                    
                    if (reunionSongs.length > 0) {
                        reunionDetails.push({ date: show.date, city: show.city, songs: reunionSongs });
                    }
                });
                if (reunionDetails.length > 0) {
                    songAchievements.push({
                        id: 'ach_reunion',
                        title: '重逢的一刻',
                        description: '你在一刻环节，听到了本不属于这座城市的限定新歌。',
                        type: 'song',
                        details: reunionDetails
                    });
                }
                
                // 3. 计算 'ach_unreleased' (遗珠不再有憾)
                let unreleasedDetails = [];
                selectedShows.forEach(show => {
                    const encore = tourData.encoreSetlists[show.id] || [];
                    const unreleasedSongs = encore.filter(song => allUnreleasedSongs.includes(song));
                    
                    if (unreleasedSongs.length > 0) {
                        unreleasedDetails.push({ date: show.date, city: show.city, songs: unreleasedSongs });
                    }
                });
                if (unreleasedDetails.length > 0) {
                     songAchievements.push({
                        id: 'ach_unreleased',
                        title: '遗珠不再有憾',
                        description: '你听到了这些未收录在旧版录音室专辑中的“遗珠”之作。',
                        type: 'song',
                        details: unreleasedDetails
                    });
                }

                // 4. 计算 'meta_city_conquer' (城市全勤)
                const cityShowCounts = concertList.reduce((acc, show) => {
                    acc[show.city] = (acc[show.city] || 0) + 1; return acc;
                }, {});
                const userCityCounts = selectedShows.reduce((acc, show) => {
                    acc[show.city] = (acc[show.city] || 0) + 1; return acc;
                }, {});
                
                let conqueredCities = [];
                for (const city in userCityCounts) {
                    if (userCityCounts[city] === cityShowCounts[city]) {
                        conqueredCities.push(city);
                    }
                }
                if (conqueredCities.length > 0) {
                    metaAchievements.push({
                        id: 'meta_city_conquer',
                        title: '城市全勤',
                        description: `我全勤了 ${conqueredCities.join('、')}！这座城市的每一刻我都未曾缺席。`,
                        type: 'experience'
                    });
                }
                
                // 5. 计算 'meta_region_master' (各地巡游)
                const regionsVisited = new Set(selectedShows.map(show => show.region));
                let achDescription = '';
                const hasAllRegions = regionsVisited.size === 3;
                const hasManyCities = totalCities >= 5;

                if (hasAllRegions && hasManyCities) {
                    achDescription = `真正的巡演旅人，我的足迹跨越了山川与海洋，遍布 ${totalCities} 座城市！`;
                } else if (hasAllRegions) {
                    achDescription = '真正的巡演旅人，我的足迹跨越了山川与海洋。';
                } else if (hasManyCities) {
                    achDescription = `真正的巡演旅人，我的足迹遍布 ${totalCities} 座城市！`;
                }

                if (hasAllRegions || hasManyCities) {
                    metaAchievements.push({
                        id: 'meta_region_master',
                        title: '各地巡游',
                        description: achDescription,
                        type: 'experience'
                    });
                }
                
                return { songAchievements, metaAchievements };
            }

            // --- V3 故事版渲染逻辑 (F3) ---

            /**
             * (V3 新增) 渲染欢迎页
             */
            function renderWelcomePage(page, data) {
                page.innerHTML = `
                    <div class="animate-pulse">
                        <h1 class="story-title">正在为你生成...</h1>
                        <p class="story-subtitle">请稍候，我们正在总结你的专属回忆</p>
                    </div>
                `;
            }

            /**
             * (V3 新增) 渲染总览页
             */
            function renderOverviewPage(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">我的“二十年一刻”总览</h1>
                    <div class="grid grid-cols-3 gap-8 text-center" style="animation: fadeIn 0.5s ease-out;">
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalShows}</div>
                            <div class="text-lg mt-2">总场次</div>
                        </div>
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalHours}</div>
                            <div class="text-lg mt-2">总时长 (h)</div>
                        </div>
                        <div>
                            <div class="text-6xl font-bold" style="color: var(--theme-primary);">${data.totalCities}</div>
                            <div class="text-lg mt-2">总城市</div>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 修改 - 要求 ①) 渲染城市与一刻页
             */
            function renderCityMoments(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">我的足迹与一刻</h1>
                    <button id="city-list-toggler" class="story-subtitle text-2xl font-semibold cursor-pointer hover:opacity-75 transition-opacity">
                        “我陪苏打绿走过了这些城市”
                        <span class="text-sm block">(点击查看)</span>
                    </button>
                    <div id="city-list-bubbles" class="mb-6 max-w-md">
                        </div>
                    
                    <h3 class="story-subtitle text-2xl font-semibold mt-4">“我听到了这些珍贵的一刻”</h3>
                    <div class="text-left max-w-md w-full p-4 report-card">
                        <ul class="list-disc list-inside space-y-2">
                            ${data.cityMoments.length > 0 ? data.cityMoments.map(song => `<li class="text-lg">${song}</li>`).join('') : '<li class="text-lg italic">暂无</li>'}
                        </ul>
                    </div>
                `;
                
                page.querySelector('#city-list-toggler').addEventListener('click', (e) => {
                    e.currentTarget.style.display = 'none'; // 隐藏按钮
                    const bubbleContainer = page.querySelector('#city-list-bubbles');
                    data.overview.uniqueCities.forEach((city, index) => {
                        const bubble = document.createElement('div');
                        bubble.className = 'city-bubble';
                        bubble.textContent = city;
                        bubble.style.animationDelay = `${index * 0.1}s`; // 依次淡入
                        bubbleContainer.appendChild(bubble);
                    });
                });
            }

            // (V4.2 重构) 渲染“我的见证” - 默认分段淡入 (要求 ①)
            function renderDefaultDetails(details) {
                if (!details || details.length === 0) return '';
                
                let html = '<ul class="list-disc list-inside pl-2 text-sm space-y-1 mt-2">';
                html += details.map((detail, index) => 
                    `<li class="detail-item-fade-in" style="animation-delay: ${index * 0.15}s;">
                        [${detail.date} ${detail.city}] 我听到了《${detail.songs.join('》、《')}》
                    </li>`
                ).join('');
                html += '</ul>';
                return html;
            }

            // (V4.3 修改) 渲染“我的见证” - 时间轴 (要求 ①, ②, ③)
            function renderTimelineDetails(details, ach) {
                if (!details || details.length === 0) return '';

                // (V4.3) 要求①: 定义哪些成就只显示城市，不显示歌曲
                const simpleTimelineAchievements = ['ach_origin', 'ach_workout', 'ach_meet_again', 'ach_thank_you', 'ach_this_day', 'ach_miss_you'];
                // (V4.3) 要求②, ③: 'ach_fishleong', 'ach_unreleased' 会返回 false，从而显示歌曲
                const showSongs = !simpleTimelineAchievements.includes(ach.id);

                let html = '<div class="timeline-container">';
                html += '<div class="timeline-line"></div>'; // 中心线
                html += details.map((detail, index) => `
                    <div class="timeline-item" style="animation-delay: ${index * 0.2}s;">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">${detail.date}</div>
                            <div class="timeline-city">${detail.city}</div>
                            ${showSongs ? `<div class="timeline-songs">我听到了《${detail.songs.join('》、《')}》</div>` : ''}
                        </div>
                    </div>
                `).join('');
                html += '</div>';
                return html;
            }

            // (V4.2 新增) 渲染“我的见证” - 重逢卡片 (要求 ③)
            function renderReunionDetails(details) {
                if (!details || details.length === 0) return '';
                
                let html = '<div class="reunion-container">';
                let animationIndex = 0;
                
                details.forEach((detail) => {
                    detail.songs.forEach((song) => {
                        const originalCity = citySongReverseMap[song] || '未知城市';
                        html += `
                        <div class="reunion-card" style="animation-delay: ${animationIndex * 0.2}s;">
                            <h3>你听到了：《${song}》</h3>
                            <p>这本是 <strong>${originalCity}</strong> 的限定一刻，</p>
                            <p>而你在 <strong>[${detail.date} ${detail.city}]</strong> 与它惊喜重逢。</p>
                        </div>`;
                        animationIndex++;
                    });
                });
                
                html += '</div>';
                return html;
            }


            /**
             * (V4.3 修改 - 重构) 渲染单个成就页 (现在是路由)
             */
            function renderAchievementPage(page, ach) {
                // (V4.3) 1. 决定使用哪种渲染方式
                // (要求 ②, ③) '鱼丁糸' 和 '遗珠' 也使用时间轴
                const timelineAchievements = ['ach_origin', 'ach_workout', 'ach_meet_again', 'ach_thank_you', 'ach_this_day', 'ach_miss_you', 'ach_fishleong', 'ach_unreleased'];
                let detailsHTML = '';
                
                // (V4.2) 2. 保证见证按日期排序
                const sortedDetails = (ach.details || []).sort((a, b) => new Date(a.date) - new Date(b.date));

                if (ach.id === 'ach_reunion') {
                    // 要求 ③: 渲染重逢卡片
                    detailsHTML = renderReunionDetails(sortedDetails);
                } else if (timelineAchievements.includes(ach.id)) {
                    // 要求 ①, ②, ③: 渲染时间轴
                    // (V4.3) 传入 'ach' 本身，让渲染器决定是否显示歌曲
                    detailsHTML = renderTimelineDetails(sortedDetails, ach); 
                } else {
                    // 要求 ① (默认): 默认使用分段淡入列表 (例如 台风)
                    detailsHTML = renderDefaultDetails(sortedDetails);
                }

                // (V4.2) 3. 渲染页面
                page.innerHTML = `
                    <div class="text-center w-full max-w-md" style="animation: fadeIn 0.5s ease-out;">
                        <h1 class="story-ach-title">🏆 ${ach.title}</h1>
                        <p class="story-ach-desc">“${ach.description}”</p>
                        
                        ${detailsHTML ? `
                        <div class="story-ach-details">
                            <div class="details-title">我的见证:</div>
                            ${detailsHTML} 
                        </div>
                        ` : ''}
                        
                        ${ach.lyric ? `<p class="text-gray-500 italic mt-4">“${ach.lyric}”</p>` : ''}
                    </div>
                `;
            }

            /**
             * (V3 新增) 渲染“元”成就合并页
             */
            function renderMetaAchievementPage(page, achievements) {
                page.innerHTML = `
                    <h1 class="story-title">我的特别印记</h1>
                    <div class="flex flex-col items-center w-full">
                    ${achievements.map((ach, index) => `
                        <div class="meta-ach-card report-card p-5 text-center" style="animation-delay: ${index * 0.4}s;">
                            <h2 class="story-ach-title text-2xl mb-2">🏆 ${ach.title}</h2>
                            <p class="story-ach-desc text-base">“${ach.description}”</p>
                        </div>
                    `).join('')}
                    </div>
                `;
            }

            /**
             * (V3 修改) 渲染稀有度统计页 (起点/终点)
             */
            function renderRarityStatsPage(page, data) {
                const renderSongList = (songs) => {
                    if (!songs || songs.length === 0) return '<li class="text-gray-500 italic text-sm">暂无</li>';
                    return songs.map(s => `<li class="text-sm">${s}</li>`).join('');
                };

                page.innerHTML = `
                    <h1 class="story-title">宇宙中的稀有讯号</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl">
                        <div class="report-card p-4">
                            <div class="text-5xl font-bold" style="color: var(--theme-primary);">${data.rarityFirst}</div>
                            <div class="text-lg font-semibold mt-1">巡演起点</div>
                            <p class="text-xs text-gray-500 mt-1">(在巡演点歌中我听到了这些歌的首次演唱)</p>
                            <ul class="list-disc list-inside mt-2 text-left">${renderSongList(data.firstSongsList)}</ul>
                        </div>
                        <div class="report-card p-4">
                            <div class="text-5xl font-bold" style="color: var(--theme-primary);">${data.rarityLast}</div>
                            <div class="text-lg font-semibold mt-1">巡演终点</div>
                            <p class="text-xs text-gray-500 mt-1">(在巡演点歌中我听到了这些歌的最后一次演唱)</p>
                            <ul class="list-disc list-inside mt-2 text-left">${renderSongList(data.lastSongsList)}</ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 修改) 渲染稀有度分级页 (L1-L4)
             */
            function renderRarityLevelsPage(page, data) {
                const renderSongList = (songs) => {
                    if (!songs || songs.length === 0) return '<li class="text-gray-500 italic text-sm">未解锁此稀有度</li>';
                    return songs.map(s => `
                        <li class="flex items-center space-x-2">
                            <input type="checkbox" class="surprise-song-check form-checkbox h-4 w-4 rounded" data-song-name="${s}" style="color: var(--theme-primary);">
                            <label class="text-sm">${s}</label>
                        </li>
                    `).join('');
                };

                page.innerHTML = `
                    <h1 class="story-title">点歌池的宝藏</h1>
                    <p class="story-subtitle text-sm mb-4">
                        请勾选你认为最惊喜、最特别的歌曲，<br>它们将出现在最终报告的“我的宝藏歌曲”列表中。
                    </p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full max-w-3xl">
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">“绝版一刻” (${data.level1.length})</h3>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level1)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">“限定重逢” (${data.level2.length})</h3>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level2)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">“珍贵相遇” (${data.level3.length})</h3>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level3)}</ul>
                        </div>
                        <div class="report-card p-3">
                            <h3 class="font-semibold text-lg" style="color: var(--theme-primary);">“热门回响” (${data.level4.length})</h3>
                            <ul class="list-disc list-inside text-left mt-2">${renderSongList(data.level4)}</ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 新增) 渲染个人点歌页
             */
            function renderEncorePage(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">属于我的安可时光</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                        <div class="report-card p-4">
                            <h3 class="font-semibold text-xl mb-2">我的常听曲目 Top 3</h3>
                            <ul class="list-decimal list-inside space-y-1 text-left">
                                ${data.top3.length > 0 ? data.top3.map(s => `<li class="text-lg">${s.name} (${s.count} 次)</li>`).join('') : '<li class="text-gray-500 italic">我听过的点歌都是独一无二的！</li>'}
                            </ul>
                        </div>
                         <div class="report-card p-4">
                            <h3 class="font-semibold text-xl mb-2">我的一面之缘曲目</h3>
                            <ul class="list-disc list-inside space-y-1 text-left">
                                ${data.once.length > 0 ? data.once.map(s => `<li class="text-base">${s}</li>`).join('') : '<li class="text-gray-500 italic">我的每首点歌都充满缘分！</li>'}
                            </ul>
                        </div>
                    </div>
                `;
            }

            /**
             * (V3 新增) 渲染可展开的专辑页
             */
            function renderAlbumPage(page, data) {
                // 按进度排序
                data.sort((a, b) => b.percentage - a.percentage);
                
                page.innerHTML = `
                    <h1 class="story-title">我的音乐拼图</h1>
                    <div class="w-full max-w-md report-card p-4 space-y-3">
                        ${data.map((album, index) => `
                            <div class="border border-gray-200 rounded-md">
                                <div id="album-header-${index}" class="accordion-header p-3" data-target="#album-content-${index}">
                                    <div class="flex justify-between text-sm font-medium mb-1">
                                        <span class="font-semibold">${album.name}</span>
                                        <span>(${album.count} / ${album.total})</span>
                                    </div>
                                    <div class="progress-bar-bg">
                                        <div class="progress-bar-fill" style="width: ${album.percentage}%;">
                                            ${album.percentage > 10 ? album.percentage + '%' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div id="album-content-${index}" class="accordion-content p-3 border-t border-gray-200 text-left">
                                    <h4 class="font-semibold text-sm">已听过 (${album.heardTracks.length})</h4>
                                    <ul class="list-disc list-inside pl-2 text-xs text-green-700">
                                        ${album.heardTracks.length > 0 ? album.heardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">暂无</li>'}
                                    </ul>
                                    <h4 class="font-semibold text-sm mt-2">未听过 (${album.unheardTracks.length})</h4>
                                    <ul class="list-disc list-inside pl-2 text-xs text-gray-400">
                                        ${album.unheardTracks.length > 0 ? album.unheardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">暂无</li>'}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                page.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = page.querySelector(header.dataset.target);
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    });
                });
            }

            /**
             * (V3 修改) 渲染最终总览页 (入口)
             */
            function renderFullReport(page, data) {
                page.innerHTML = `
                    <h1 class="story-title">我的旅程已汇总</h1>
                    <p class="story-subtitle">这是我的“二十年一刻”完整报告，<br>感谢我参与过这一刻，成为这趟旅程的一部分。</p>
                    <button id="show-full-report-btn" class="story-nav-btn">查看完整报告</button>
                `;
                
                // 填充最终报告页的数据 (在后台)
                populateFullReportPage(data);
                
                page.querySelector('#show-full-report-btn').addEventListener('click', () => {
                    storyContainer.style.display = 'none';
                    fullReportPage.style.display = 'block';
                    storyNav.style.display = 'none'; 
                    window.scrollTo(0, 0);
                });
            }

            
            // --- 最终报告页 渲染函数 (F3 - Full Report) ---

            /**
             * 填充最终报告页
             */
            function populateFullReportPage(data) {
                renderFullReportOverview(data.overview);
                renderFullReportAchievements(data.allAchievements);
                renderFullReportRarity(data.rarity);
                renderFullReportEncore(data.encore, [...surpriseSongs]); 
                renderFullReportAlbums(data.albums);
            }

            function renderFullReportOverview(data) {
                document.getElementById('full-total-shows').textContent = data.totalShows;
                document.getElementById('full-total-hours').textContent = data.totalHours;
                document.getElementById('full-total-cities').textContent = data.totalCities;
                document.getElementById('full-city-list').textContent = data.cityListText;
            }

            /**
             * (V3 新增 - 要求 ④) 渲染简化的成就墙
             */
            function renderFullReportAchievements(achievementsData) {
                const container = document.getElementById('full-achievement-grid');
                if (achievementsData.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 italic text-center">我尚未解锁任何特殊成就。</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="flex flex-wrap justify-center gap-2">
                        ${achievementsData.map(ach => `
                            <div class="achievement-card p-2 px-3">
                                <span class="title text-sm">🏆 ${ach.title}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            /**
             * (V3 修改 - 最终版) 渲染简化的稀有度
             */
            function renderFullReportRarity(data) {
                const raritySection = document.getElementById('full-rarity-grid').closest('section.report-card');
                
                if (data.totalListSongs === 0 && data.totalStatSongs === 0) {
                    raritySection.style.display = 'none';
                    return;
                }
                raritySection.style.display = 'block';

                // 1. 渲染统计 (Start/End/Exclusive)
                document.getElementById('full-rarity-first').textContent = data.rarityFirst;
                document.getElementById('full-rarity-last').textContent = data.rarityLast;
                // V4 最终修改: '独家一刻' -> '点歌总数'
                document.getElementById('full-rarity-total-songs').textContent = data.totalListSongs;
                
                // 2. 渲染 L1-L4 数量
                document.getElementById('full-rarity-l1-count').textContent = data.level1.length;
                document.getElementById('full-rarity-l2-count').textContent = data.level2.length;
                document.getElementById('full-rarity-l3-count').textContent = data.level3.length;
                document.getElementById('full-rarity-l4-count').textContent = data.level4.length;
            }
            
            /**
             * (V3 修改 - 要求 ④) 渲染个人点歌 (Top3 + 惊喜)
             */
            function renderFullReportEncore(data, surpriseSongsList) {
                document.getElementById('full-encore-top3').innerHTML = data.top3.map(s => `<li>${s.name} (${s.count} 次)</li>`).join('') || '<li class="text-gray-500 italic">我听过的点歌都是独一无二的！</li>';
                
                document.getElementById('full-encore-once').innerHTML = surpriseSongsList.length > 0 
                    ? surpriseSongsList.map(s => `<li>${s}</li>`).join('') 
                    : '<li class="text-gray-500 italic">暂无 (重新返回故事页勾选吧！)</li>';
            }
            
            // (V3 修改) 最终报告页的专辑列表 (可展开)
            function renderFullReportAlbums(data) {
                const container = document.getElementById('full-album-progress-grid');
                // 按进度排序
                data.sort((a, b) => b.percentage - a.percentage);
                
                container.innerHTML = data.map((album, index) => `
                    <div class="border border-gray-200 rounded-md">
                        <div id="full-album-header-${index}" class="accordion-header p-3" data-target="#full-album-content-${index}">
                            <div class="flex justify-between text-sm font-medium mb-1">
                                <span class="font-semibold">${album.name}</span>
                                <span>(${album.count} / ${album.total})</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${album.percentage}%;">
                                    ${album.percentage > 10 ? album.percentage + '%' : ''}
                                </div>
                            </div>
                        </div>
                        <div id="full-album-content-${index}" class="accordion-content p-3 border-t border-gray-200 text-left">
                                <h4 class="font-semibold text-sm">已听过 (${album.heardTracks.length})</h4>
                                <ul class="list-disc list-inside pl-2 text-xs text-green-700">
                                    ${album.heardTracks.length > 0 ? album.heardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">暂无</li>'}
                                </ul>
                                <h4 class="font-semibold text-sm mt-2">未听过 (${album.unheardTracks.length})</h4>
                                <ul class="list-disc list-inside pl-2 text-xs text-gray-400">
                                    ${album.unheardTracks.length > 0 ? album.unheardTracks.map(s => `<li>${s}</li>`).join('') : '<li class="italic text-gray-500">暂无</li>'}
                                </ul>
                        </div>
                    </div>
                `).join('');
                
                container.querySelectorAll('.accordion-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = container.querySelector(header.dataset.target);
                        header.classList.toggle('open');
                        content.classList.toggle('open');
                    });
                });
            }


            // --- V3 故事版导航 (Story Navigation) ---

            /**
             * (V3) 1. 创建故事页面序列
             */
            function createStoryPages(data) {
                storyPages = []; // 重置
                
                // 1. 欢迎页 (加载页)
                storyPages.push({ type: 'welcome' });
                
                // 2. 总览页
                storyPages.push({ type: 'overview', data: data.overview });
                
                // 3. 城市与一刻页
                storyPages.push({ type: 'city-moments', data: { overview: data.overview, cityMoments: data.cityMoments }});

                // 4. 歌曲成就页 (动态)
                if (data.achievements.length > 0) {
                    data.achievements.forEach(ach => {
                        storyPages.push({ type: 'achievement', data: ach });
                    });
                }
                
                // 5. “元”成就页 (合并)
                if (data.metaAchievements.length > 0) {
                    storyPages.push({ type: 'meta-achievements', data: data.metaAchievements });
                }
                
                // 6. 稀有度 (要求 ③: 新的两个页面)
                if (data.rarity.totalStatSongs > 0) {
                     storyPages.push({ type: 'rarity-stats', data: data.rarity });
                }
                if (data.rarity.totalListSongs > 0) {
                     storyPages.push({ type: 'rarity-levels', data: data.rarity });
                }

                // 7. 个人点歌页
                storyPages.push({ type: 'encore', data: data.encore });
                
                // 8. 专辑点亮页
                storyPages.push({ type: 'albums', data: data.albums });
                
                // 9. 最终报告入口页
                storyPages.push({ type: 'full-report', data: data });

                return storyPages;
            }

            /**
             * (V5 美化 ②) 2. 渲染当前页面 (已重构为返回 page)
             */
            function renderCurrentPage() {
                const pageData = storyPages[currentPageIndex];
                
                // 创建新页面
                const page = document.createElement('div');
                page.className = 'story-page';
                
                // 检查是否为可滚动页面
                const isScrollable = [
                    'albums', 
                    'rarity-stats', 
                    'rarity-levels', 
                    'encore',
                    'city-moments', 
                    'achievement', 
                    'meta-achievements'
                ].includes(pageData.type);

                if (isScrollable) {
                    page.classList.add('scrollable');
                    page.style.position = 'relative'; 
                    storyContainer.style.height = 'auto';
                    storyContainer.style.overflow = 'visible';
                    storyContainer.style.maxHeight = 'none';
                } else {
                    page.style.position = 'absolute';
                    storyContainer.style.height = '100vh';
                    storyContainer.style.overflow = 'hidden';
                    storyContainer.style.maxHeight = '100svh';
                }
                
                // 根据类型填充内容 (路由)
                switch (pageData.type) {
                    case 'welcome':
                        renderWelcomePage(page, pageData.data);
                        break;
                    case 'overview':
                        renderOverviewPage(page, pageData.data);
                        break;
                    case 'city-moments':
                        renderCityMoments(page, pageData.data);
                        break;
                    case 'achievement':
                        renderAchievementPage(page, pageData.data);
                        break;
                    case 'meta-achievements':
                        renderMetaAchievementPage(page, pageData.data);
                        break;
                    case 'rarity-stats': 
                        renderRarityStatsPage(page, pageData.data);
                        break;
                    case 'rarity-levels':
                        renderRarityLevelsPage(page, pageData.data);
                        break;
                    case 'encore':
                        renderEncorePage(page, pageData.data);
                        break;
                    case 'albums':
                        renderAlbumPage(page, pageData.data);
                        break;
                    case 'full-report':
                        renderFullReport(page, pageData.data);
                        break;
                }
                
                // (V5 美化 ②) 不在此处附加或激活，只返回 page
                return page;
            }

            /**
             * (V3 新增) 3. 更新导航按钮状态
             */
            function updateNavButtons() {
                // 欢迎页 (加载页) 隐藏导航
                if (storyPages[currentPageIndex].type === 'welcome') {
                    storyNav.style.display = 'none';
                    return;
                }
                // (!!! 修复 !!!) 最终报告入口页也隐藏导航
                if (storyPages[currentPageIndex].type === 'full-report') {
                    storyNav.style.display = 'none';
                    return;
                }
                
                storyNav.style.display = 'flex';
                prevBtn.style.display = (currentPageIndex === 0 || currentPageIndex === 1) ? 'none' : 'block'; // 第一页(欢迎)和第二页(总览)不显示"上一页"
                nextBtn.style.display = (currentPageIndex === storyPages.length - 1) ? 'none' : 'block'; // 最后一页不显示"下一页"
            }

            /**
             * (V5 美化 ②) 4. 导航逻辑 (已重构)
             */
            function changePage(direction) {
                // (V4 修改) 在翻页时，保存惊喜歌曲
                if (direction > 0 && storyPages[currentPageIndex].type === 'rarity-levels') {
                    // 从 L1-L4 页面收集惊喜歌曲
                    const checks = storyContainer.querySelectorAll('.surprise-song-check:checked');
                    surpriseSongs = new Set(Array.from(checks).map(c => c.dataset.songName));
                    // (实时更新最终报告)
                    if (allReportData.encore) {
                        renderFullReportEncore(allReportData.encore, [...surpriseSongs]);
                    }
                }

                const newIndex = currentPageIndex + direction;
                if (newIndex < 0 || newIndex >= storyPages.length) return; // 越界检查
                
                const oldPage = storyContainer.querySelector('.story-page.active');
                
                currentPageIndex = newIndex;
                const newPage = renderCurrentPage(); // 创建新页面

                // (V5 美化 ②) 执行翻页动画
                if (oldPage) {
                    oldPage.classList.remove('active');
                    oldPage.classList.add(direction > 0 ? 'slide-out-to-left' : 'slide-out-to-right');
                    setTimeout(() => {
                        oldPage.remove(); // 动画结束后移除旧页面
                    }, 500); // 必须匹配 CSS 动画时间
                }
                
                newPage.classList.add(direction > 0 ? 'slide-in-from-right' : 'slide-in-from-left');
                storyContainer.appendChild(newPage);
                
                // 强制重绘以启动动画
                void newPage.offsetWidth; 
                
                // 激活新页面 (触发 'active' 样式)
                newPage.classList.add('active');
                // (V5.1 修复) 动画结束后移除 'slide-in' 类，防止回退时出错
                setTimeout(() => {
                    newPage.classList.remove('slide-in-from-right', 'slide-in-from-left');
                }, 500);
                
                updateNavButtons();

                // 如果是可滚动页面，滚动到页面顶部
                if (newPage.classList.contains('scrollable')) {
                    window.scrollTo(0, 0);
                }
            }


            // --- Gemini API (要求 ①: 保持注释) ---
            
            /*
            async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            }
            */
            
            /*
            async function callGeminiAPI(report) {
                geminiGenerateBtn.style.display = 'none';
                geminiOutput.style.display = 'none';
                geminiLoading.style.display = 'block';

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                // 构建提示词
                let prompt = `你是一位资深的苏打绿乐迷和情感文案作家。请根据以下用户“二十年一刻”的观演数据，为TA撰写一段约200字的、专属的、充满诗意和情感的观演总结。
                
                规则：
                1. 必须使用中文。
                2. 风格要贴合苏打绿的歌词气质，文艺、温柔、有力量。
                3. **必须自然地**融合以下数据，而不是生硬地罗列：
                
                用户数据：
                - 观演场次: ${report.overview.totalShows} 场
                - 观演城市: ${report.overview.uniqueCities.join('、')}
                - 解锁的成就: ${report.achievements.length > 0 ? report.achievements.map(a => `“${a.title}”`).join(', ') : '暂无'}
                - 最稀有的“绝版一刻”歌曲: ${report.rarity.level1.length > 0 ? report.rarity.level1[0] : '暂无'}
                - 听过最多次的点歌 (常听曲目): ${report.encore.top3.length > 0 ? `${report.encore.top3[0].name} (${report.encore.top3[0].count}次)` : '暂无'}

                请直接开始撰写这篇总结。`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };

                try {
                    const result = await fetchWithRetry(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.JSON.stringify(payload)
                    });
                    
                    const text = result.candidates[0].content.parts[0].text;
                    geminiOutput.textContent = text;
                    geminiOutput.style.display = 'block';
                } catch (error) {
                    geminiOutput.textContent = '生成专属回忆失败，请稍后再试。';
                    geminiOutput.style.display = 'block';
                    geminiGenerateBtn.style.display = 'block';
                } finally {
                    geminiLoading.style.display = 'none';
                }
            }
            */


            /**
             * (V3) 主函数：生成报告
             */
            function generateReport() {
                // 1. 获取输入
                const userShowIDs = getSelectedShowIDs();
                
                if (userShowIDs.length === 0) {
                    showAlert('请至少选择一个场次');
                    return;
                }
                
                // 2. 切换到故事页
                selectionPage.style.display = 'none';
                storyContainer.style.display = 'block';
                currentPageIndex = 0; // 从欢迎页开始
                
                // (V5 美化 ②) 渲染第一页 (欢迎页)，不使用 changePage
                const welcomePage = renderCurrentPage();
                storyContainer.appendChild(welcomePage);
                welcomePage.classList.add('active'); // 直接激活，无动画
                updateNavButtons();
                
                // 3. (异步) 启动计算
                // 用 setTimeout 确保欢迎页(加载页)能先渲染出来
                setTimeout(() => {
                    // (F2) 一次性计算所有数据
                    const selectedShows = getSelectedShows(userShowIDs);
                    const { uniqueSongs, uniqueEncoreSongs, encoreSongsWithDuplicates } = getCompleteUserSongList(userShowIDs, selectedShows);
                    
                    const overviewData = calculateOverview(userShowIDs, selectedShows);
                    
                    const { songAchievements, metaAchievements } = calculateAchievements(userShowIDs, selectedShows, overviewData.totalCities);
                    
                    allReportData = {
                        overview: overviewData,
                        cityMoments: calculateCityMoments(selectedShows),
                        albums: calculateAlbumProgress(uniqueSongs),
                        encore: calculateEncoreStats(encoreSongsWithDuplicates),
                        rarity: calculateRarity(uniqueEncoreSongs, userShowIDs),
                        achievements: songAchievements, 
                        metaAchievements: metaAchievements,
                        allAchievements: [...songAchievements, ...metaAchievements].sort((a,b) => a.id.startsWith('meta_') ? 1 : -1)
                    };

                    // (V3) 生成故事页面序列
                    storyPages = createStoryPages(allReportData);
                    
                    // 4. 计算完成，跳转到下一页 (总览页)
                    // (V5 美化 ②) 使用 changePage 触发滑动
                    changePage(1); // 跳转到总览页
                    
                }, 500); // 给 0.5 秒显示“正在生成”
            }
            
            // --- 绑定事件 ---
            
            // V4 修改: DOMContentLoaded 现在只用于启动数据加载
            initializeApp();
            
            // V3 导航事件
            prevBtn.addEventListener('click', () => changePage(-1));
            nextBtn.addEventListener('click', () => changePage(1));
            
            // (要求 ③) 新增: 为惊喜歌曲复选框添加事件委托
            storyContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('surprise-song-check')) {
                    const songName = e.target.dataset.songName;
                    if (e.target.checked) {
                        surpriseSongs.add(songName);
                    } else {
                        surpriseSongs.delete(songName);
                    }
                    // (!!!) 实时更新最终报告页的数据
                    if (allReportData.encore) {
                        renderFullReportEncore(allReportData.encore, [...surpriseSongs]);
                    }
                }
            });
            
            // 最终报告页的重置按钮
            resetBtn.addEventListener('click', () => {
                // 重置所有状态
                fullReportPage.style.display = 'none';
                selectionPage.style.display = 'block';
                allReportData = {};
                storyPages = [];
                currentPageIndex = 0;
                surpriseSongs.clear(); // (要求 ③) 重置惊喜歌曲
                
                // (要求 ①: 保持注释)
                // 重置 Gemini 模块
                // geminiOutput.style.display = 'none';
                // geminiOutput.textContent = '';
                // geminiGenerateBtn.style.display = 'block';
                
                // 重置选择框
                document.querySelectorAll('.show-checkbox:checked').forEach(box => box.checked = false);
                document.querySelectorAll('.accordion-content.open').forEach(content => content.classList.remove('open'));
                document.querySelectorAll('.accordion-header.open').forEach(header => header.classList.remove('open'));
                
                window.scrollTo(0, 0);
            });
            
            // Modal 事件
            modalCloseBtn.addEventListener('click', closeAlert);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeAlert();
            });
            
            // (要求 ①: 保持注释)
            // Gemini 按钮事件
            /*
            geminiGenerateBtn.addEventListener('click', () => {
                // 确保 allReportData 已填充
                if (allReportData.overview) {
                    callGeminiAPI(allReportData);
                }
            });
            */
        });
    </script>
</body>
</html>
